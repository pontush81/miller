<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WizWealth90 – Chris "The Wiz" Miller Program</title>
  <meta name="description" content="90-Day Wealth Identity Program in the style of Chris Miller">
  <meta name="theme-color" content="#0b0f16">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#0b0f16; --card:#121826; --muted:#8ea0b5; --text:#e8eef7; 
      --acc:#7bd88f; --acc2:#8ab4ff; --border:#1c2635; --input:#152032;
      --hover:#2f466b; --pill:#0f1a2a; --pillBorder:#21314b;
      --mantraBg:#10192a; --mantraBorder:#8ab4ff; --textarea:#10192a;
      --textareaBorder:#1e2b44; --badge:#10263b; --badgeBorder:#234b73;
      --badgeText:#cde3ff; --warm:#ffd479;
    }
    [data-theme="light"] {
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b; --text:#111827;
      --acc:#10b981; --acc2:#3b82f6; --border:#e2e8f0; --input:#f1f5f9;
      --hover:#cbd5e1; --pill:#f8fafc; --pillBorder:#cbd5e1;
      --mantraBg:#eff6ff; --mantraBorder:#3b82f6; --textarea:#f8fafc;
      --textareaBorder:#cbd5e1; --badge:#dbeafe; --badgeBorder:#93c5fd;
      --badgeText:#1e40af; --warm:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;transition:background 0.3s, color 0.3s;letter-spacing:0.01em}
    
    /* Animations */
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(20px); }
      to { opacity:1; transform:translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(139, 180, 255, 0); }
      50% { box-shadow: 0 0 20px 5px rgba(139, 180, 255, 0.3); }
    }
    @keyframes themeRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .fade-in { animation: fadeInUp 0.6s ease-out; }
    header{position:sticky;top:0;background:var(--bg);z-index:5;padding:16px 20px 8px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .header-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    main{max-width:920px;margin:24px auto;padding:0 16px 60px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button, input[type="number"], select {border:1px solid var(--border);background:var(--input);color:var(--text);padding:8px 16px;border-radius:20px;cursor:pointer;transition:all 0.3s;font-weight:500}
    button:hover{border-color:var(--hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .theme-toggle{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:12px;cursor:pointer;font-size:18px;transition:all 0.3s}
    .theme-toggle:hover{border-color:var(--hover);transform:scale(1.05)}
    .theme-toggle.rotating{animation:themeRotate 0.5s ease-in-out}
    .pill{background:var(--pill);border:1px solid var(--pillBorder);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;transition:background 0.3s, border 0.3s;box-shadow:0 8px 24px rgba(0,0,0,0.1)}
    h2{font-size:22px;margin:0 0 16px;font-weight:700;letter-spacing:0.02em}
    h3{font-size:16px;margin:24px 0 12px;color:var(--text);opacity:0.9;font-weight:600;letter-spacing:0.03em}
    @media (max-width:768px){
      h2{font-size:20px;margin:0 0 12px}
      h3{font-size:15px;margin:18px 0 10px}
    }
    .kicker{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
    .big{font-size:15px}
    ul{margin:8px 0 0 18px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:var(--badge);border:1px solid var(--badgeBorder);color:var(--badgeText);padding:3px 8px;border-radius:8px;font-size:12px}
    .mantra{border-left:3px solid var(--mantraBorder);padding:16px 20px;background:var(--mantraBg);border-radius:12px;margin:6px 0;color:var(--text);font-weight:600;letter-spacing:0.02em;cursor:pointer;transition:all 0.3s;animation:mantraGlow 6s ease-in-out infinite;font-size:18px;line-height:1.5;position:relative}
    .mantra::after{content:'📋';position:absolute;right:16px;top:50%;transform:translateY(-50%);opacity:0.4;font-size:16px;transition:opacity 0.2s}
    .mantra:hover{transform:scale(1.02);box-shadow:0 0 20px rgba(255,212,121,0.2)}
    .mantra:hover::after{opacity:0.8}
    .ok{color:var(--acc)}
    .danger{color:#ff8a8a}
    .hr{height:1px;background:linear-gradient(90deg, transparent, var(--border), transparent);margin:16px 0}
    
    /* Progress Bar */
    .progress-container{margin:12px 0 24px;padding:0}
    .progress-label{font-size:12px;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between;font-weight:500}
    .progress-bar{height:6px;background:var(--input);border-radius:10px;overflow:hidden;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg, var(--acc), var(--acc2));border-radius:10px;transition:width 0.6s ease-out;position:relative}
    .progress-fill::after{content:'';position:absolute;top:0;right:0;bottom:0;left:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation:shimmer 2s infinite}
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes mantraGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,212,121,0.08); }
      50% { box-shadow: 0 0 24px 0 rgba(255,212,121,0.14); }
    }
    @keyframes donePulse {
      0% { box-shadow: 0 0 0 0 rgba(123,216,143,0); }
      50% { box-shadow: 0 0 24px 2px rgba(123,216,143,0.25); }
      100% { box-shadow: 0 0 0 0 rgba(123,216,143,0); }
    }
    @keyframes fade {
      from { opacity:0; transform:translateY(4px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    /* Energy Symbol */
    .energy-badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg, rgba(123,216,143,0.1), rgba(138,180,255,0.1));border:1px solid var(--acc);padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:12px}
    .energy-symbol{font-size:20px}
    
    /* Wisdom Quote */
    .wisdom-quote{background:linear-gradient(135deg, var(--mantraBg), var(--input));border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-style:italic;color:var(--text);opacity:0.9;font-size:14px;line-height:1.6}
    .footer{font-size:12px;color:var(--muted);margin-top:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .small{font-size:12px}
    textarea{width:100%;min-height:110px;background:var(--textarea);color:var(--text);border:1px solid var(--textareaBorder);border-radius:10px;padding:10px;transition:background 0.3s, border 0.3s}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    a.link{color:var(--acc2)}
    .goal-widget{background:var(--mantraBg);border:none;border-radius:10px;padding:12px;margin:12px 0}
    .goal-input{width:100%;background:var(--textarea);border:none !important;outline:none;color:var(--text);padding:10px;border-radius:8px;font-size:13px;transition:all 0.2s;-webkit-appearance:none}
    .goal-input:focus{outline:none !important;border:none !important;background:var(--input);box-shadow:0 0 0 2px rgba(123,216,143,0.3)}
    .goal-list{list-style:none;padding:0;margin:8px 0 0}
    .goal-item{display:flex;gap:8px;align-items:center;padding:6px 0;font-size:13px;animation:fadeInUp 0.3s ease-out}
    .goal-checkbox{width:16px;height:16px;cursor:pointer;flex-shrink:0}
    .goal-text{flex:1;cursor:text;padding:2px 6px;border-radius:4px;transition:background 0.2s}
    .goal-text:hover{background:var(--hover)}
    .goal-text:focus{outline:none;background:var(--input);box-shadow:0 0 0 1px var(--acc2)}
    .goal-completed{text-decoration:line-through;opacity:0.6}
    .goal-delete{background:transparent;border:none;cursor:pointer;font-size:16px;opacity:0.5;transition:all 0.2s;padding:4px;flex-shrink:0}
    .goal-delete:hover{opacity:1;transform:scale(1.2)}
    .domino-why{display:block;font-size:13px;color:var(--muted);margin-top:4px;line-height:1.5}
    .domino-item{margin-bottom:12px;position:relative;padding-left:0;transition:all 0.3s}
    .domino-item:hover .domino-why{color:var(--text);opacity:0.9}
    
    /* HERO BANNER FOR DAILY THEME */
    .theme-hero{background:linear-gradient(135deg, rgba(123,216,143,0.15), rgba(138,180,255,0.15), rgba(255,107,107,0.1));border:none;border-radius:12px;padding:16px 20px;margin:12px 0;text-align:center;position:relative;overflow:hidden}
    .theme-hero::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.03) 50%, transparent 70%);animation:shimmer 3s infinite}
    .theme-hero .emoji{font-size:24px;display:block;margin-bottom:6px}
    .theme-hero .theme-text{font-size:16px;font-weight:700;color:var(--text);line-height:1.3;margin:0}
    @media (max-width:768px){
      .theme-hero{padding:14px 16px}
      .theme-hero .emoji{font-size:22px}
      .theme-hero .theme-text{font-size:15px}
    }
    
    /* PROMINENT FIRST DOMINO SECTION */
    .domino-section{background:linear-gradient(135deg, rgba(123,216,143,0.08), rgba(138,180,255,0.08));border:2px solid var(--acc);border-radius:16px;padding:20px;margin:20px 0;box-shadow:0 4px 20px rgba(123,216,143,0.15)}
    .domino-section h3{margin-top:0;color:var(--acc);font-size:16px}
    .domino-why-icon{cursor:pointer;display:inline-flex;align-items:center;gap:4px;font-size:12px;color:var(--acc2);margin-left:8px;opacity:0.8;transition:all 0.2s}
    .domino-why-icon:hover{opacity:1;transform:scale(1.05)}
    
    /* COLLAPSIBLE SECTIONS */
    .collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;padding:8px 0}
    .collapsible-header:hover h3{color:var(--acc2)}
    .collapsible-toggle{font-size:20px;transition:transform 0.3s;color:var(--muted)}
    .collapsible-toggle.expanded{transform:rotate(180deg)}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
    .collapsible-content.expanded{max-height:2000px}
    
    /* TOOLTIPS */
    .tooltip{position:relative;display:inline-block;border-bottom:1px dotted var(--acc2);cursor:help}
    .tooltip .tooltiptext{visibility:hidden;width:240px;background:var(--card);color:var(--text);text-align:left;border-radius:8px;padding:10px 12px;position:absolute;z-index:1000;bottom:125%;left:50%;margin-left:-120px;opacity:0;transition:opacity 0.3s;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:13px;line-height:1.5}
    .tooltip .tooltiptext::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:var(--border) transparent transparent transparent}
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
    
    /* STREAK COUNTER */
    .streak-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg, #ff6b6b, #ff8e53);padding:6px 12px;border-radius:20px;font-size:13px;font-weight:600;color:#fff;box-shadow:0 2px 8px rgba(255,107,107,0.3)}
    .streak-badge .flame{font-size:16px;animation:flicker 1.5s infinite}
    @keyframes flicker{0%,100%{opacity:1}50%{opacity:0.8}}
    
    /* PROGRESS CALENDAR */
    .progress-calendar{display:grid;grid-template-columns:repeat(7, 1fr);gap:6px;margin:12px 0}
    .progress-day{aspect-ratio:1;border-radius:6px;background:var(--input);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;border:1px solid var(--border);position:relative}
    .progress-day:hover{transform:scale(1.15);z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .progress-day.done{background:var(--acc);color:var(--card);border-color:var(--acc)}
    .progress-day.current{border:2px solid var(--acc2);box-shadow:0 0 8px var(--acc2)}
    @media (max-width:768px){
      .progress-calendar{gap:4px}
      .progress-day{font-size:11px}
    }
    
    /* V2 SCORE TRACKER */
    .v2-score-widget{background:var(--mantraBg);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0;transition:transform 0.2s}
    .v2-score-widget h4{margin:0 0 8px;font-size:14px;color:var(--muted)}
    .v2-score-input-group{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .v2-score-input{flex:1;appearance:none;height:12px;border-radius:10px;background:var(--input);outline:none;transition:all 0.2s}
    .v2-score-input::-webkit-slider-thumb{appearance:none;width:28px;height:28px;border-radius:50%;background:var(--acc);cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .v2-score-input::-webkit-slider-thumb:hover{transform:scale(1.1);box-shadow:0 0 12px var(--acc)}
    .v2-score-input::-webkit-slider-thumb:active{transform:scale(1.2)}
    .v2-score-input::-moz-range-thumb{width:28px;height:28px;border-radius:50%;background:var(--acc);cursor:pointer;border:none;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .v2-score-value{font-size:24px;font-weight:700;color:var(--acc);min-width:40px;text-align:center}
    .v2-sparkline{display:flex;align-items:flex-end;gap:4px;height:40px}
    .v2-sparkline-bar{flex:1;background:var(--acc);border-radius:2px 2px 0 0;opacity:0.8;transition:all 0.2s;min-width:8px;cursor:pointer;position:relative}
    .v2-sparkline-bar::before{content:'';position:absolute;top:-8px;left:-4px;right:-4px;bottom:0;cursor:pointer}
    .v2-sparkline-bar:hover{opacity:1;transform:scaleX(1.3) scaleY(1.05);z-index:10}
    .v2-sparkline-bar.today{opacity:1;box-shadow:0 0 8px rgba(0,0,0,0.3)}
    .v2-sparkline-bar.low{background:#e74c3c}
    .v2-sparkline-bar.medium{background:#f39c12}
    .v2-sparkline-bar.high{background:var(--acc)}
    @media (max-width:768px){
      .v2-score-input{height:16px}
      .v2-score-input::-webkit-slider-thumb{width:32px;height:32px}
      .v2-score-input::-moz-range-thumb{width:32px;height:32px}
    }
    
    /* SETTINGS MENU */
    .settings-menu{position:relative;display:inline-block}
    .settings-btn{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:12px;cursor:pointer;font-size:16px;transition:all 0.3s;animation:settingsPulse 3s ease-in-out infinite}
    .settings-btn:hover{border-color:var(--hover);transform:scale(1.05);animation:none}
    @keyframes settingsPulse{0%,100%{opacity:1}50%{opacity:0.6;transform:scale(1.05)}}
    .settings-dropdown{display:none;position:absolute;top:100%;right:0;margin-top:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:180px;box-shadow:0 8px 20px rgba(0,0,0,0.3);z-index:10}
    .settings-dropdown.show{display:block}
    .settings-item{padding:12px 16px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border);transition:background 0.2s}
    .settings-item:hover{background:var(--input)}
    .settings-item:last-child{border-bottom:none}
    .settings-item.danger:hover{background:rgba(255,138,138,0.1)}
    
    /* SIMPLIFIED NAVIGATION */
    .day-nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .day-display{font-size:15px;font-weight:600;padding:8px 16px;background:var(--input);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.3s}
    .day-display:hover{border-color:var(--acc2);background:var(--hover)}
    .keyboard-hint{font-size:11px;color:var(--muted);text-align:center;margin-top:4px;opacity:0.6;font-style:italic}
    
    /* ONBOARDING */
    .onboarding-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
    .onboarding-modal{background:var(--card);border:2px solid var(--acc);border-radius:20px;padding:32px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .onboarding-modal h2{margin:0 0 16px;font-size:24px;color:var(--acc)}
    .onboarding-modal p{margin:12px 0;line-height:1.7;font-size:15px}
    .onboarding-dots{display:flex;gap:8px;justify-content:center;margin:20px 0}
    .onboarding-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all 0.3s}
    .onboarding-dot.active{background:var(--acc);width:24px;border-radius:4px}
    .onboarding-buttons{display:flex;gap:12px;justify-content:space-between;margin-top:24px}
    
    /* RESPONSIVE IMPROVEMENTS */
    .mobile-tabs{display:none} /* Hidden on desktop */
    
    /* Large desktops (1440px+) */
    @media (min-width:1440px){
      main{max-width:1200px}
      .card{padding:32px}
      h2{font-size:24px}
    }
    
    /* Tablets & small desktops (768px - 900px) */
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      main{max-width:100%}
      aside.card{margin-top:16px}
    }
    
    /* Tablets portrait (768px and below) */
    @media (max-width:768px){
      .header-row{flex-direction:column;align-items:flex-start;gap:12px}
      .header-row > div:last-child{width:100%;justify-content:space-between}
      .toolbar{flex-direction:column;align-items:stretch}
      .day-nav{width:100%;justify-content:center}
      main{padding:0 16px 80px}
      .card{padding:20px}
      .mobile-tabs{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:12px 8px;z-index:10;box-shadow:0 -4px 12px rgba(0,0,0,0.2)}
      .mobile-tab{flex:1;text-align:center;padding:12px 8px;cursor:pointer;border-radius:8px;transition:all 0.2s;font-size:13px;min-height:44px}
      .mobile-tab:hover{background:var(--input)}
      .mobile-tab.active{background:var(--acc);color:var(--card)}
      .mobile-tab .icon{font-size:24px;display:block;margin-bottom:4px}
      .settings-dropdown{right:auto;left:0}
      .profile-dropdown{right:auto;left:0}
    }
    
    /* Mobile (414px and below) */
    @media (max-width:414px){
      body{font-size:15px}
      h1{font-size:18px}
      h2{font-size:18px}
      h3{font-size:14px}
      .sub{font-size:12px}
      main{padding:0 12px 80px}
      .card{padding:16px}
      button, input[type="number"], select{padding:12px 16px;min-height:44px}
      .day-display{padding:12px 16px;min-height:44px}
      .completion-item{padding:12px 8px;min-height:44px}
      .goal-item{padding:12px 0}
      .goal-checkbox{width:24px;height:24px}
      .onboarding-modal{padding:20px;font-size:15px}
      .onboarding-modal h2{font-size:20px}
      .progress-label{font-size:13px}
      .mobile-tab{font-size:11px;padding:10px 4px}
      .mobile-tab .icon{font-size:20px}
      .domino-section{padding:16px}
      .domino-why{font-size:12px}
    }
    
    /* Small mobile (375px and below) */
    @media (max-width:375px){
      h1{font-size:16px}
      .card{padding:12px}
      .streak-badge{font-size:11px;padding:4px 8px}
      .mobile-tab{padding:8px 2px;font-size:10px}
      .mobile-tab .icon{font-size:18px;margin-bottom:2px}
    }
    
    /* Toast notifications */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 16px;opacity:0;transition:opacity 0.3s;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:14px;max-width:90vw}
    .toast.show{opacity:1}
    @media (max-width:768px){
      .toast{bottom:90px;font-size:13px;padding:8px 12px}
    }
    
    /* Done button */
    #btnDone{background:var(--acc);color:var(--card);font-weight:600;margin:16px auto 12px;width:60%;max-width:280px;display:block;transition:all 0.3s}
    #btnDone:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(123,216,143,0.3)}
    #btnDone.completed{background:var(--input);color:var(--muted);cursor:default}
    #btnDone.completed:hover{transform:none;box-shadow:none}
    .fadeIn{animation:fade 0.25s ease}
    .donePulse{animation:donePulse 0.6s ease}
    
    /* Profile modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.4)}
    .modal h2{margin:0 0 12px;font-size:20px}
    .modal p{color:var(--muted);margin:0 0 16px;font-size:14px}
    .modal input{width:100%;padding:10px;background:var(--input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
    .modal-buttons{display:flex;gap:8px;justify-content:flex-end}
    .profile-selector{position:relative;display:inline-block}
    .profile-btn{display:flex;align-items:center;gap:6px;background:var(--input);border:1px solid var(--border);padding:6px 12px;border-radius:10px;cursor:pointer;font-size:13px}
    .profile-btn:hover{border-color:var(--hover)}
    .profile-dropdown{display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:10px;min-width:200px;box-shadow:0 8px 16px rgba(0,0,0,0.3);z-index:10}
    .profile-dropdown.show{display:block}
    .profile-item{padding:10px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border)}
    .profile-item:hover{background:var(--input)}
    .profile-item:last-child{border-bottom:none}
    .profile-item.active{color:var(--acc);font-weight:600}
    .profile-item.delete{color:var(--danger)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div>
        <h1>WizWealth90</h1>
        <div class="sub">Chris "The Wiz" Miller – 90‑Day Wealth Identity Program</div>
      </div>
      <div class="row">
        <div id="streakBadge" class="streak-badge" style="display:none">
          <span class="flame">🔥</span>
          <span id="streakCount">0 days</span>
        </div>
        <div class="profile-selector">
          <button class="profile-btn" id="profileBtn" title="Switch profile">
            👤 <span id="currentProfile">Profile</span>
          </button>
          <div class="profile-dropdown" id="profileDropdown">
            <div id="profileList"></div>
            <div class="profile-item" id="btnNewProfile" style="border-top:1px solid var(--border)">+ New profile</div>
          </div>
        </div>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">🌙</button>
        <div class="settings-menu">
          <button class="settings-btn" id="settingsBtn" title="Settings">⚙️</button>
          <div class="settings-dropdown" id="settingsDropdown">
            <div class="settings-item" id="btnExportSettings">📤 Export data</div>
            <div class="settings-item" id="btnImportSettings">📥 Import data</div>
            <div class="settings-item danger" id="btnResetSettings">🔄 Reset all data</div>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Progress Bar -->
  <div class="progress-container" style="max-width:920px;margin:16px auto;padding:0 16px">
    <div class="progress-label">
      <span id="progressText">Day 1 of 90 • Week 1</span>
      <span id="progressPercent">1%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:1%"></div>
    </div>
  </div>
  
  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="modalTitle">Welcome! 👋</h2>
      <p id="modalDesc">Create your profile to start the program. Multiple people can use the same device.</p>
      <input type="text" id="profileNameInput" placeholder="Your name (e.g., Anna, John…)" maxlength="30">
      <div class="modal-buttons">
        <button id="modalCancel" class="hidden">Cancel</button>
        <button id="modalConfirm" class="ok">Create profile</button>
      </div>
    </div>
  </div>
  <main>
    <div class="toolbar">
      <div class="day-nav">
        <button id="btnPrev" title="Previous day">← Prev</button>
        <div class="day-display" id="dayDisplay" title="Click to jump to a specific day">
          <span id="dayDisplayText">Day 1 of 90</span>
      </div>
        <button id="btnNext" style="background:var(--acc);color:#0b0f16;border-color:var(--acc);font-weight:600" title="Next day">Next →</button>
    </div>
      <div class="keyboard-hint">Tip: Use ← → arrow keys</div>
      <input id="gotoDay" type="number" min="1" max="90" style="display:none">
    </div>
    <input id="importFile" type="file" accept="application/json" style="display:none">

    <div class="grid">
      <section class="card fade-in" id="dayCard">
        <div class="kicker" id="kicker"></div>
        <h2 id="title"></h2>
        <p id="explain" class="muted" style="margin-top:-2px;margin-bottom:8px"></p>
        
        <!-- HERO BANNER FOR DAILY THEME -->
        <div class="theme-hero">
          <span class="emoji" id="themeEmoji">🎯</span>
          <p class="theme-text" id="themeText">Loading theme...</p>
        </div>
        
        <div class="hr"></div>
        
        <!-- WISDOM QUOTE -->
        <div class="wisdom-quote" id="wisdomQuote" style="margin-top:16px">"You are not here to fix yourself. You are here to remember."</div>
        
        <div id="pep" class="big"></div>
        
        <!-- PROMINENT FIRST DOMINO SECTION -->
        <div class="domino-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="margin:0">🎯 <span class="tooltip">First Domino<span class="tooltiptext">The ONE action today that creates momentum. Small move, big impact.</span></span></h3>
            <div style="color:var(--muted);font-size:12px" id="dominoIndicator">1/3</div>
          </div>
          <div id="dominoContent" style="min-height:80px"></div>
          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="btnDominoPrev" style="padding:8px 12px;font-size:16px" title="Previous idea">←</button>
            <button id="btnDominoNext" style="flex:1;padding:10px;background:var(--acc);color:var(--card);border-color:var(--acc);font-weight:600">Next →</button>
          </div>
        </div>
        
        <!-- COLLAPSIBLE ROUTINE SECTION -->
        <div class="collapsible-header" data-section="routine">
          <h3>🕒 10–15 min: Daily Miller routine</h3>
          <span class="collapsible-toggle">▼</span>
        </div>
        <div class="collapsible-content" id="routineSection">
          <ul id="routine"></ul>
        </div>
        
        <!-- COLLAPSIBLE EVENING SECTION -->
        <div class="collapsible-header" data-section="evening">
          <h3>🌙 Evening debrief</h3>
          <span class="collapsible-toggle">▼</span>
        </div>
        <div class="collapsible-content" id="eveningSection">
        <ul id="evening"></ul>
        </div>
        
        <button id="btnDone" aria-label="Mark day as complete and save notes">💾 Mark complete & save notes</button>
        
        <!-- COLLAPSIBLE MANTRA SECTION -->
        <div class="collapsible-header" data-section="mantra">
          <h3>💬 Daily mantra</h3>
          <span class="collapsible-toggle">▼</span>
        </div>
        <div class="collapsible-content" id="mantraSection">
          <div id="mantra" class="mantra mono" title="Click to copy"></div>
        </div>
      </section>

      <aside class="card">
        <h3>📆 Weekly theme</h3>
        <div id="weekTheme" class="big"></div>
        
        <div class="hr"></div>
        <h3>🎯 Weekly goals</h3>
        <div class="goal-widget">
          <input type="text" class="goal-input" id="newGoal" placeholder="This week I will... (e.g., 'Close 1 deal')">
          <ul class="goal-list" id="goalList"></ul>
        </div>
        
        <div class="hr"></div>
        <h3><span class="tooltip">V2 Score<span class="tooltiptext">Version 2.0 of you - the wealthy identity you're becoming. Rate 0-10 how much you embodied it today.</span></span></h3>
        <div class="v2-score-widget">
          <h4>V2 Score (0-10): Vitality & Vision</h4>
          <div class="v2-score-input-group">
            <input type="range" id="v2ScoreInput" class="v2-score-input" min="0" max="10" value="5" step="1">
            <div class="v2-score-value" id="v2ScoreValue">5</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div class="v2-sparkline" id="v2Sparkline" style="flex:1"></div>
            <div id="v2Average" style="font-size:12px;color:var(--muted);margin-left:12px;min-width:60px;text-align:right"></div>
          </div>
        </div>
        
        <div class="hr"></div>
        <h3>📊 Progress Overview</h3>
        <div class="progress-calendar" id="progressCalendar"></div>
        
        <div class="hr"></div>
        <h3>📝 Notes</h3>
        <textarea id="notes" placeholder="Reflect on today... What went well?" maxlength="500"></textarea>
        <div class="row small" style="margin-top:6px">
          <div class="grow muted"><span id="charCount">0</span>/500 • 💾 Autosaved</div>
          <button id="btnClearNotes">Clear</button>
        </div>
        
        <div class="hr"></div>
        <h3>🧰 Quick tools</h3>
        <ul class="small">
          <li><b>Micro-reset (30s):</b> Breathe 4-2-6 + say "I choose abundance now".</li>
          <li><b>Coffee anchor:</b> Take the first sip as if you were already financially free.</li>
          <li><b>Input diet:</b> 10% less negative input today.</li>
        </ul>
      </aside>
    </div>
    
    <!-- MOBILE TABS -->
    <div class="mobile-tabs">
      <div class="mobile-tab active" data-tab="today">
        <span class="icon">📅</span>
        <span>Today</span>
      </div>
      <div class="mobile-tab" data-tab="goals">
        <span class="icon">🎯</span>
        <span>Goals</span>
      </div>
      <div class="mobile-tab" data-tab="notes">
        <span class="icon">📝</span>
        <span>Notes</span>
      </div>
    </div>
  </main>
  
  <!-- ONBOARDING MODAL -->
  <div id="onboardingModal" class="onboarding-overlay hidden">
    <div class="onboarding-modal">
      <h2 id="onboardingTitle">Welcome to WizWealth90! 🎯</h2>
      <p id="onboardingText">This is a 90-day program to transform your wealth identity, inspired by Chris "The Wiz" Miller.</p>
      <div class="onboarding-dots">
        <div class="onboarding-dot active" data-slide="0"></div>
        <div class="onboarding-dot" data-slide="1"></div>
        <div class="onboarding-dot" data-slide="2"></div>
        <div class="onboarding-dot" data-slide="3"></div>
      </div>
      <div class="onboarding-buttons">
        <button id="onboardingSkip" style="background:transparent;color:var(--muted)">Skip</button>
        <button id="onboardingNext" class="ok">Next →</button>
      </div>
    </div>
  </div>

  <script>
    // ---- Supabase Configuration ----
    const SUPABASE_URL = 'https://glqywwuchtpzehhuwbro.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXl3d3VjaHRwemVoaHV3YnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NzkxMjQsImV4cCI6MjA2OTU1NTEyNH0.XseH2QeuVShm-CEQdtvND1Yjp1IecA8Sg-dsqQMf1Qs';
    
    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // User ID management (anonymous mode)
    function getUserId() {
      let userId = localStorage.getItem('wizwealth90.userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('wizwealth90.userId', userId);
      }
      return userId;
    }
    
    // ---- Supabase Wrapper Functions ----
    
    // Daily Notes
    async function saveNoteToSupabase(day, content) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('daily_notes')
        .upsert({ 
          user_id: userId, 
          day: day, 
          content: content 
        }, { 
          onConflict: 'user_id,day' 
        });
      if (error) console.error('Error saving note:', error);
      return !error;
    }
    
    async function loadNoteFromSupabase(day) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('daily_notes')
        .select('content')
        .eq('user_id', userId)
        .eq('day', day)
        .single();
      if (error && error.code !== 'PGRST116') console.error('Error loading note:', error);
      return data?.content || '';
    }
    
    // Weekly Goals
    async function saveGoalsToSupabase(week, goals) {
      const userId = getUserId();
      
      // Delete existing goals for this week
      await sb
        .from('weekly_goals')
        .delete()
        .eq('user_id', userId)
        .eq('week', week);
      
      // Insert new goals
      if (goals.length > 0) {
        const goalsData = goals.map(goal => ({
          user_id: userId,
          week: week,
          goal_text: goal.text,
          completed: goal.completed
        }));
        
        const { error } = await sb
          .from('weekly_goals')
          .insert(goalsData);
        
        if (error) console.error('Error saving goals:', error);
      }
    }
    
    async function loadGoalsFromSupabase(week) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('weekly_goals')
        .select('*')
        .eq('user_id', userId)
        .eq('week', week)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading goals:', error);
        return [];
      }
      
      return data.map(g => ({
        text: g.goal_text,
        completed: g.completed
      }));
    }
    
    // Profile Data
    async function saveProfileToSupabase(profileData) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('profiles')
        .upsert({
          id: userId,
          name: profileData.name,
          current_day: profileData.currentDay,
          theme: profileData.theme
        }, {
          onConflict: 'id'
        });
      if (error) console.error('Error saving profile:', error);
      return !error;
    }
    
    async function loadProfileFromSupabase() {
      const userId = getUserId();
      const { data, error } = await sb
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();
      
      if (error && error.code !== 'PGRST116') console.error('Error loading profile:', error);
      return data;
    }
    
    const STORAGE_PROFILES = 'wizwealth90.profiles';
    const STORAGE_CURRENT_PROFILE = 'wizwealth90.currentProfile';
    const STORAGE_KEY_DAY = 'wizwealth90.day';
    const STORAGE_NOTES_PREFIX = 'wizwealth90.notes.';
    const STORAGE_THEME = 'wizwealth90.theme';
    const STORAGE_GOALS_PREFIX = 'wizwealth90.goals.';
    
    // --- Daily explanation templates (keeps your exact day phrases) ---
    const EXPLAIN_BY_PHASE = {
      reset: [
        'Start from who you are—not what numbers say. Create from within.',
        'Worry collapses signal; presence restores it. Evidence follows state.',
        'Stop chasing outcomes; broadcast a clean signal and let proof appear.',
        'Regulate first. A safe body lets wealth strategy land.'
      ],
      encode: [
        'Let your body feel "already owned". Feeling is the order slip.',
        'Identity speaks before results arrive. Lead with who you are.',
        "Speak from a real memory of winning and let it set today's tone.",
        'What you encode repeatedly becomes how you show up automatically.'
      ],
      embody: [
        'Decide, move and communicate like the wealthy version of you.',
        'Stack three tiny wins daily until it runs on autopilot.',
        'Design your space and routines so the right action is the easy one.',
        'Less friction, more throughput—ease increases capacity.'
      ],
      integrate: [
        'Hold this as normal, not a spike. Baseline is the game.',
        'Celebrate micro-proofs to lock them into your nervous system.',
        'Tighten the behaviors you now consider your minimum standard.',
        'Keep the identity online in small choices; it sticks.'
      ]
    };

    const EXPLAIN_HINTS_BY_TITLE = [
      {match:/reset|loop/i, addon:'Reset the loop by returning to presence, not panic.'},
      {match:/presence/i,    addon:'Presence is power. Let numbers follow your state.'},
      {match:/source/i,      addon:'You set the signal; money reflects it back.'},
      {match:/breathe|create/i, addon:'Slow breath first; then choose the action that matches identity.'},
      {match:/feeling/i,     addon:'Feeling is the receipt—embody it before evidence.'},
      {match:/V2/i,          addon:'Score the V2 version of you and note what moved the number.'},
      {match:/autopilot|Wiz-30/i, addon:'Three small wins build the autopilot you can trust.'},
      {match:/ease/i,        addon:"Ease is not laziness; it's smart throughput."},
      {match:/baseline|standard/i, addon:'Normalize your next level as the new minimum.'},
      {match:/celebrate|anchor/i, addon:'What you celebrate, your body repeats.'}
    ];

    function buildExplanation(phaseKey, title){
      const idx = Math.max(0, (title?.length || 0) % 4);
      let base = EXPLAIN_BY_PHASE[phaseKey][idx];
      for (const rule of EXPLAIN_HINTS_BY_TITLE) {
        if (rule.match.test(title || '')) {
          return base + ' ' + rule.addon;
        }
      }
      return base;
    }
    
    // ---- Profile Management ----
    function getAllProfiles(){
      const stored = localStorage.getItem(STORAGE_PROFILES);
      return stored ? JSON.parse(stored) : [];
    }
    
    function saveAllProfiles(profiles){
      localStorage.setItem(STORAGE_PROFILES, JSON.stringify(profiles));
    }
    
    function getCurrentProfile(){
      const id = localStorage.getItem(STORAGE_CURRENT_PROFILE);
      if (!id) return null;
      const profiles = getAllProfiles();
      return profiles.find(p => p.id === id) || null;
    }
    
    function setCurrentProfile(profileId){
      localStorage.setItem(STORAGE_CURRENT_PROFILE, profileId);
      updateProfileDisplay();
    }
    
    function createProfile(name){
      const profiles = getAllProfiles();
      const id = 'profile_' + Date.now();
      const newProfile = {
        id: id,
        name: name.trim(),
        createdAt: new Date().toISOString()
      };
      profiles.push(newProfile);
      saveAllProfiles(profiles);
      setCurrentProfile(id);
      return newProfile;
    }
    
    function deleteProfile(profileId){
      const profiles = getAllProfiles();
      const filtered = profiles.filter(p => p.id !== profileId);
      saveAllProfiles(filtered);
      
      // Clean up profile data
      for(let i=1; i<=90; i++){
        localStorage.removeItem(profileKey(profileId, STORAGE_NOTES_PREFIX + i));
      }
      for(let w=1; w<=13; w++){
        localStorage.removeItem(profileKey(profileId, STORAGE_GOALS_PREFIX + w));
      }
      localStorage.removeItem(profileKey(profileId, STORAGE_KEY_DAY));
      localStorage.removeItem(profileKey(profileId, STORAGE_THEME));
      
      // Switch to another profile or show modal
      if (filtered.length > 0){
        setCurrentProfile(filtered[0].id);
        renderDay(getCurrentDay());
      } else {
        localStorage.removeItem(STORAGE_CURRENT_PROFILE);
        showProfileModal(true);
      }
    }
    
    function profileKey(profileId, key){
      return `${profileId}.${key}`;
    }
    
    function updateProfileDisplay(){
      const profile = getCurrentProfile();
      if (profile){
        document.getElementById('currentProfile').textContent = profile.name;
      }
      renderProfileList();
    }
    
    function renderProfileList(){
      const profiles = getAllProfiles();
      const current = getCurrentProfile();
      const list = document.getElementById('profileList');
      list.innerHTML = '';
      
      // Add profile items
      profiles.forEach(profile => {
        const div = document.createElement('div');
        div.className = 'profile-item' + (profile.id === current?.id ? ' active' : '');
        div.textContent = profile.name;
        div.addEventListener('click', async () => {
          setCurrentProfile(profile.id);
          await renderDay(getCurrentDay());
          toggleProfileDropdown();
        });
        list.appendChild(div);
      });
      
      // Add delete options (if more than 1 profile)
      if (profiles.length > 1){
        profiles.forEach(profile => {
          const delDiv = document.createElement('div');
          delDiv.className = 'profile-item delete';
          delDiv.textContent = '🗑️ Remove ' + profile.name;
          delDiv.style.fontSize = '11px';
          delDiv.style.paddingLeft = '24px';
          delDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`Delete profile "${profile.name}"? All data for this profile will be removed.`)){
              deleteProfile(profile.id);
            }
          });
          list.appendChild(delDiv);
        });
      }
    }
    
    function toggleProfileDropdown(){
      document.getElementById('profileDropdown').classList.toggle('show');
    }
    
    function showProfileModal(isFirst = false){
      document.getElementById('profileModal').classList.remove('hidden');
      document.getElementById('profileNameInput').value = '';
      document.getElementById('profileNameInput').focus();
      
      if (isFirst){
        document.getElementById('modalTitle').textContent = 'Welcome! 👋';
        document.getElementById('modalDesc').textContent = 'Create your profile to start the program. Multiple people can use the same device.';
        document.getElementById('modalCancel').classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = 'Create new profile';
        document.getElementById('modalDesc').textContent = 'Each profile has its own progress and notes.';
        document.getElementById('modalCancel').classList.remove('hidden');
      }
    }
    
    function hideProfileModal(){
      document.getElementById('profileModal').classList.add('hidden');
    }
    
    async function handleProfileCreate(){
      const name = document.getElementById('profileNameInput').value.trim();
      if (!name){
        alert('Enter a name for the profile.');
        return;
      }
      
      createProfile(name);
      hideProfileModal();
      
      // Verify profile was created
      if (!getCurrentProfile()) {
        alert('An error occurred while creating the profile. Try again.');
        return;
      }
      
      // Initialize app after profile creation
      updateProfileDisplay();
      initTheme();
      
      const key = dayKey();
      if (key && !localStorage.getItem(key)) {
        localStorage.setItem(key, '1');
      }
      
      await renderDay(getCurrentDay());
    }

    function generateProgram(){
      const weeks = [
        {phase:'Self-Perception Reset', theme:'I am the source — not the numbers'},
        {phase:'Self-Perception Reset', theme:'From worry → presence'},
        {phase:'Belief Encoding', theme:'I am wealth'},
        {phase:'Belief Encoding', theme:'Feeling before evidence'},
        {phase:'Belief Encoding', theme:'V2 score & anchors'},
        {phase:'Belief Encoding', theme:'Synchronicity & trust'},
        {phase:'Frequency Embodiment', theme:'Move like the wealthy'},
        {phase:'Frequency Embodiment', theme:'Wiz-30 = autopilot'},
        {phase:'Frequency Embodiment', theme:'Environment design for money'},
        {phase:'Frequency Embodiment', theme:'Ease scales revenue'},
        {phase:'Integration', theme:'New baseline established'},
        {phase:'Integration', theme:'Celebrate, anchor, refine'},
        {phase:'Integration', theme:'Live the new standard'}  // Week 13 (days 85–90)
      ];

      const mantras = {
        reset:[
          'I am the awareness behind it all.',
          'Worry is just an old loop. I choose abundance.',
          'I am safe in the now; money moves to me.',
          'I observe — I am not my thoughts.'
        ],
        encode:[
          'I am a person money is drawn to.',
          'Feeling is the receipt.',
          'I am wealth in motion.',
          'My presence creates value now.'
        ],
        embody:[
          'I move like wealth.',
          'Ease serves me financially.',
          'Every action carries my new identity.',
          'I am the standard; money matches me.'
        ],
        integrate:[
          'This is my new baseline.',
          'I deserve and I receive.',
          'I choose peace; I choose wealth.',
          'Gratitude multiplies my flow.'
        ]
      };

      // Miller-toned First Dominos with one-line explanations
      const dominoPools = {
        reset:[
          {text:'Mute one negative input that lowers your signal.', why:'Reduce one source of worry (feed, chat, alert). Nervous system calms; clarity rises.'},
          {text:'Write a "thank you, past me" letter (5 min).', why:'Appreciation integrates lessons so you can release the old identity.'},
          {text:'Clear one small financial friction — open the flow.', why:'Cancel a leak (unused subscription, clutter). Action anchors a new baseline.'},
          {text:'List three money‑worry triggers and rewrite each into safety.', why:'Reframe the story → choose safety. Safety is the wealth signal.'}
        ],
        encode:[
          {text:'Record five "I am …" statements with emotion; listen tonight.', why:'Your own voice trains the subconscious to accept the identity.'},
          {text:'Create a V2 image and set it as your phone background.', why:'Constant visual exposure accelerates identity encoding.'},
          {text:'Invite a micro‑manifestation today.', why:'Ask for one unexpected compliment/opportunity. Proof builds belief.'},
          {text:'Describe your 12‑month "wealth moment" in three sentences.', why:'A single vivid scene gives the body something real to follow.'}
        ],
        embody:[
          {text:'Reach out to one person (client, partner, friend).', why:'Connection expands surface area for opportunity — movement signals readiness.'},
          {text:'Publish or share one piece of value today.', why:'Expression broadcasts frequency. The world mirrors clarity, not perfection.'},
          {text:'Sell or offer something small — even symbolic.', why:'Exchange activates circulation; abundance loves velocity.'},
          {text:'Delegate or automate one draining task.', why:'Removing friction raises energetic ROI; freedom creates capacity.'}
        ],
        integrate:[
          {text:'List your new non‑negotiables.', why:'Naming standards stabilizes the level — your system learns "this is normal".'},
          {text:'Celebrate three wins — big or small.', why:'Celebration locks success into muscle memory; gratitude multiplies it.'},
          {text:'Plan one 30–90‑day "wealth ops" upgrade.', why:'Iterating prevents contraction and invites expansion.'},
          {text:'Book one rewarding experience to anchor identity.', why:'Pleasure confirms safety — wealth feels calm, not chaotic.'}
        ]
      };

      const pep = {
        reset: [
          'Drink your coffee as if it were already true. You are bigger than the numbers.',
          'Worry is a body habit — not a forecast. Today you choose presence.',
          'You don\'t have to chase — you tune the signal. Let opportunities find you.',
          'Breathe 4‑2‑6 and feel the field go quiet. Direction is created here.'
        ],
        encode: [
          'Feeling before evidence: let the body feel "already owned."',
          'Affirmations work when they feel. Speak from a memory of a win.',
          'You are the person money looks for. Enter the room as such.',
          'Practice micro‑manifestation — let the world nod back.'
        ],
        embody: [
          'Move like wealth: simple, clear, generous with focus.',
          'Wiz‑30 is your autopilot — three small wins are enough.',
          'Environment before willpower: make right action easy.',
          'Ease scales revenue. Work smart, not heavy.'
        ],
        integrate: [
          'This is your new baseline. Let it show in small choices.',
          'Celebrate and anchor — what you celebrate, repeats.',
          'The last kilometer builds the habit. Keep the rhythm soft and steady.',
          'Gratitude multiplies. Say thank you out loud today.'
        ]
      };

      const routineByPhase = {
        reset: [
          '2 min still awareness: I observe; I am not my thoughts.',
          '3 min writing: What worries me? How does my wealthy self respond?',
          '5 min revision: play a new scene where you act as V2.'
        ],
        encode: [
          '3 min "I am …" with feeling (5–7 lines).',
          '4 min scene visualization: a concrete wealth moment.',
          '2 min physical anchor (hand on heart + slow breathing).'
        ],
        embody: [
          '1 min coffee anchor — "it\'s already mine."',
          '7 min First Domino (one small income‑moving action).',
          '2 min V2 score: 0–10 — what made the difference?'
        ],
        integrate: [
          '3 min gratitude for the evidence you see.',
          '5 min refine: what becomes my new minimum standard?',
          "2 min plan for tomorrow's First Domino."
        ]
      };

      const evening = [
        'V2 score (0–10) & micro‑win.',
        'What triggered worry? What will I do differently next time?',
        'One proof that the flow worked for me today.',
        'One thing I simplify/eliminate tomorrow.'
      ];

      const days = [];
      for(let d=1; d<=90; d++){
        const weekIndex = Math.floor((d-1)/7);
        const wk = weeks[weekIndex];
        let phaseKey = 'reset';
        if (wk.phase.startsWith('Belief')) phaseKey = 'encode';
        else if (wk.phase.startsWith('Frequency')) phaseKey = 'embody';
        else if (wk.phase.startsWith('Integration')) phaseKey = 'integrate';

        const titles = {
          reset: ['Reset the loop','Presence leads','You are the source','Breathe, choose, create'],
          encode: ['I am wealth','Feeling first','V2 body leads','Practice proof'],
          embody: ['Move like wealth','Wiz‑30 = autopilot','Ease over force','Show the standard'],
          integrate: ['Baseline','Celebrate & anchor','Refine the standard','The new you stays']
        };
        const title = titles[phaseKey][d % 4];
        const pepMsg = pep[phaseKey][d % pep[phaseKey].length];
        const mantra = ({
          reset: mantras.reset,
          encode: mantras.encode,
          embody: mantras.embody,
          integrate: mantras.integrate
        })[phaseKey][d % 4];

        const dom = ({
          reset: dominoPools.reset,
          encode: dominoPools.encode,
          embody: dominoPools.embody,
          integrate: dominoPools.integrate
        })[phaseKey];

        const phrase = title; // keep your exact phrase as main heading
        const explain = buildExplanation(phaseKey, title);

        days.push({
          day: d,
          phase: wk.phase,
          weekTheme: wk.theme,
          title,
          phrase,
          explain,
          pep: pepMsg,
          routine: routineByPhase[phaseKey],
          domino: [dom[d % dom.length], dom[(d+1) % dom.length], dom[(d+2) % dom.length]],
          evening,
          mantra
        });
      }
      return days;
    }

    const PROGRAM = generateProgram();
    
    // ---- Wisdom Quotes ----
    const WISDOM_QUOTES = [
      "You are not here to fix yourself. You are here to remember.",
      "Wealth is a frequency before it's a number.",
      "Your past doesn't equal your future unless you let it.",
      "The Universe doesn't respond to need. It responds to signal.",
      "You don't attract what you want. You attract who you are.",
      "Comfort is expensive. Clarity is free.",
      "Your nervous system is your wealth ceiling.",
      "You become the 5 identities you spend the most time in.",
      "Manifestation without embodiment is fantasy.",
      "Money loves speed and clarity.",
      "Your current results are yesterday's thoughts becoming today's reality.",
      "The gap between where you are and where you want to be is called 'practice'.",
      "You don't need more strategy. You need more sovereignty.",
      "Wealth is an inside job that shows up outside.",
      "Your breakthrough is on the other side of your pattern.",
      "Energy is currency. Spend it wisely.",
      "What you tolerate, you teach the Universe to send you more of.",
      "Your vibe is your tribe. Your frequency is your fortune.",
      "The fastest way to wealth is to become the person who already has it.",
      "You can't hustle your way into alignment.",
      "Trust the timing. Question the fear.",
      "Your next level requires a new level of you.",
      "Scarcity is learned. Abundance is your natural state.",
      "The Universe doesn't work for you. It works through you."
    ];
    
    // ---- Theme ----
    function getWeekNumber(day){ return Math.floor((day-1)/7)+1; }
    function goalsKey(week){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_GOALS_PREFIX + week); 
    }
    function notesKey(day){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_NOTES_PREFIX + day); 
    }
    function dayKey(){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_KEY_DAY); 
    }
    function themeKey(){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_THEME); 
    }

    function initTheme(){
      const key = themeKey();
      const saved = key ? localStorage.getItem(key) || 'dark' : 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    function toggleTheme(){
      const key = themeKey();
      if (!key) return;
      
      // Add rotation animation
      const toggle = document.getElementById('themeToggle');
      toggle.classList.add('rotating');
      setTimeout(() => toggle.classList.remove('rotating'), 500);
      
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(key, next);
      updateThemeIcon(next);
    }

    function updateThemeIcon(theme){
      document.getElementById('themeToggle').textContent = theme === 'dark' ? '☀️' : '🌙';
    }

    // ---- Goals ----
    async function loadGoals(week){
      // Try Supabase first
      const supabGoals = await loadGoalsFromSupabase(week);
      if (supabGoals && supabGoals.length > 0) {
        return supabGoals;
      }
      
      // Fallback to localStorage
      const stored = localStorage.getItem(goalsKey(week));
      return stored ? JSON.parse(stored) : [];
    }

    async function saveGoals(week, goals){
      // Save to both Supabase and localStorage
      await saveGoalsToSupabase(week, goals);
      localStorage.setItem(goalsKey(week), JSON.stringify(goals));
    }

    async function renderGoals(week){
      const goals = await loadGoals(week);
      const list = document.getElementById('goalList');
      list.innerHTML = '';
      
      goals.forEach((goal, idx) => {
        const li = document.createElement('li');
        li.className = 'goal-item';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'goal-checkbox';
        cb.checked = goal.completed;
        cb.addEventListener('change', async ()=>{
          goals[idx].completed = cb.checked;
          await saveGoals(week, goals);
          await renderGoals(week);
        });
        
        const span = document.createElement('span');
        span.contentEditable = true;
        span.textContent = goal.text;
        span.className = 'goal-text ' + (goal.completed ? 'goal-completed' : '');
        span.setAttribute('data-original', goal.text);
        
        // Edit on blur (when user clicks away)
        span.addEventListener('blur', async ()=>{
          const newText = span.textContent.trim();
          if (newText && newText !== goal.text) {
            goals[idx].text = newText;
            await saveGoals(week, goals);
            span.setAttribute('data-original', newText);
          } else if (!newText) {
            // Restore if empty
            span.textContent = span.getAttribute('data-original');
          }
        });
        
        // Save on Enter, cancel on Escape
        span.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') {
            e.preventDefault();
            span.blur();
          } else if (e.key === 'Escape') {
            span.textContent = span.getAttribute('data-original');
            span.blur();
          }
        });
        
        // Delete button
        const delBtn = document.createElement('button');
        delBtn.className = 'goal-delete';
        delBtn.innerHTML = '🗑️';
        delBtn.title = 'Remove goal';
        delBtn.addEventListener('click', async ()=>{
          if (confirm('Remove this goal?')) {
            goals.splice(idx, 1);
            await saveGoals(week, goals);
            await renderGoals(week);
          }
        });
        
        li.appendChild(cb);
        li.appendChild(span);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    async function addGoal(week, text){
      if (!text.trim()) return;
      const goals = await loadGoals(week);
      goals.push({text: text.trim(), completed: false});
      await saveGoals(week, goals);
      await renderGoals(week);
      document.getElementById('newGoal').value = '';
      toast('✓ Goal added!');
    }

    // ---- Toast Notifications ----
    function toast(msg){ 
      let t = document.querySelector('.toast'); 
      if(!t){ 
        t = document.createElement('div'); 
        t.className = 'toast'; 
        document.body.appendChild(t); 
      }
      t.textContent = msg; 
      t.classList.add('show'); 
      setTimeout(() => t.classList.remove('show'), 1500);
    }

    // ---- Done State ----
    function getDoneKey(day){
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, 'wizwealth90.done.' + day);
    }

    function isDayDone(day){
      const key = getDoneKey(day);
      if (!key) return false;
      return localStorage.getItem(key) === '1';
    }

    function markDayDone(day){
      const key = getDoneKey(day);
      if (!key) return;
      localStorage.setItem(key, '1');
    }

    function updateDoneButton(day){
      const btn = document.getElementById('btnDone');
      if (!btn) return;
      
      if (isDayDone(day)){
        btn.textContent = '✓ Day completed';
        btn.classList.add('completed');
        btn.disabled = true;
      } else {
        btn.textContent = '✨ Mark day as done';
        btn.classList.remove('completed');
        btn.disabled = false;
      }
    }

    // ---- UI helpers ----
    const el = (id)=>document.getElementById(id);
    
    let currentDominoIndex = 0;
    let currentDominoList = [];
    
    function renderDomino(list){
      currentDominoList = list;
      currentDominoIndex = 0;
      updateDominoDisplay();
    }
    
    function updateDominoDisplay(){
      const content = document.getElementById('dominoContent');
      const indicator = document.getElementById('dominoIndicator');
      const prevBtn = document.getElementById('btnDominoPrev');
      const nextBtn = document.getElementById('btnDominoNext');
      
      if (!content || currentDominoList.length === 0) return;
      
      const item = currentDominoList[currentDominoIndex];
      content.innerHTML = `
        <div style="font-size:15px;font-weight:600;margin-bottom:8px">${item.text}</div>
        <div class="domino-why">${item.why}</div>
      `;
      
      // Update indicator
      if (indicator){
        indicator.textContent = `${currentDominoIndex + 1}/${currentDominoList.length}`;
      }
      
      // Update button states
      if (prevBtn) prevBtn.disabled = currentDominoIndex === 0;
      if (nextBtn) nextBtn.disabled = currentDominoIndex === currentDominoList.length - 1;
    }
    
    // Domino navigation handlers
    document.getElementById('btnDominoPrev')?.addEventListener('click', ()=>{
      if (currentDominoIndex > 0){
        currentDominoIndex--;
        updateDominoDisplay();
      }
    });
    
    document.getElementById('btnDominoNext')?.addEventListener('click', ()=>{
      if (currentDominoIndex < currentDominoList.length - 1){
        currentDominoIndex++;
        updateDominoDisplay();
      }
    });
    
    function getCurrentDay(){
      const key = dayKey();
      const v = parseInt(key ? localStorage.getItem(key) || '1' : '1', 10);
      return isNaN(v)?1:Math.max(1, Math.min(90, v));
    }

    async function renderDay(n){
      if (!getCurrentProfile()) return; // Guard: no profile
      
      n = Math.max(1, Math.min(90, n));
      const key = dayKey();
      if (key) localStorage.setItem(key, String(n));
      
      const d = PROGRAM[n-1];
      const week = getWeekNumber(d.day);
      const kicker = `Day ${d.day} • Week ${week} • ${d.phase}`;
      
      // Progress bar
      const progress = Math.round((n / 90) * 100);
      el('progressText').textContent = `Day ${n} of 90 • Week ${week}`;
      el('progressPercent').textContent = `${progress}%`;
      const progressBar = el('progressFill');
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('role', 'progressbar');
      progressBar.setAttribute('aria-valuemin', '1');
      progressBar.setAttribute('aria-valuemax', '90');
      progressBar.setAttribute('aria-valuenow', String(n));
      
      // Wisdom quote (rotate based on day)
      const wisdom = WISDOM_QUOTES[n % WISDOM_QUOTES.length];
      el('wisdomQuote').textContent = `"${wisdom}"`;

      el('kicker').textContent = kicker;
      el('title').textContent = d.phrase || d.title;   // show your exact phrase
      el('explain').textContent = d.explain || '';     // show the short explanation
      
      // Hero banner theme
      const phaseEmojis = {
        'CALIBRATION':'🎯',
        'SATISFACTION RESET':'✨',
        'DAILY MILLER ROUTINE':'🔄'
      };
      el('themeEmoji').textContent = phaseEmojis[d.phase] || '🌟';
      el('themeText').textContent = d.weekTheme;
      
      el('weekTheme').textContent = d.weekTheme;
      el('pep').textContent = d.pep;

      const ulR = el('routine'); ulR.innerHTML='';
      d.routine.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulR.appendChild(li); });

      renderDomino(d.domino);

      const ulE = el('evening'); ulE.innerHTML='';
      d.evening.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulE.appendChild(li); });

      el('mantra').textContent = d.mantra || '';
      
      // Trigger fade-in animation
      const card = el('dayCard');
      card.classList.remove('fade-in');
      void card.offsetWidth; // Force reflow
      card.classList.add('fade-in');
      
      await loadNotes(n);
      await renderGoals(week);
      updateDoneButton(n);
      updateStreakCounter();
      updateDayDisplay();
      loadV2ScoreForDay(n);
      renderProgressCalendar();
    }

    function nextDay(){ 
      if (!getCurrentProfile()) return;
      renderDay(getCurrentDay()+1); 
    }
    function prevDay(){ 
      if (!getCurrentProfile()) return;
      renderDay(getCurrentDay()-1); 
    }

    async function saveNotes(day){ 
      const content = el('notes').value;
      await saveNoteToSupabase(day, content);
      
      // Also save to localStorage as backup
      const key = notesKey(day);
      if (key) localStorage.setItem(key, content);
    }
    
    async function loadNotes(day){ 
      // Try Supabase first, fallback to localStorage
      const supabContent = await loadNoteFromSupabase(day);
      
      if (supabContent) {
        el('notes').value = supabContent;
      } else {
        // Fallback to localStorage
        const key = notesKey(day);
        el('notes').value = key ? localStorage.getItem(key) || '' : '';
      }
      
      // Update character count
      document.getElementById('charCount').textContent = el('notes').value.length;
    }

    // Export/import state (day + notes + goals)
    function exportState(){
      const profile = getCurrentProfile();
      if (!profile) {
        alert('No profile selected. Create a profile first.');
        return;
      }
      
      const goalData = {};
      for(let w=1; w<=13; w++){
        const goals = loadGoals(w);
        if (goals.length > 0) goalData[w] = goals;
      }
      
      const themeK = themeKey();
      const data = {
        profileName: profile.name,
        day: getCurrentDay(),
        theme: themeK ? localStorage.getItem(themeK) || 'dark' : 'dark',
        notes: Object.fromEntries(
          Array.from({length:90}, (_,i)=>{
            const key = notesKey(i+1);
            return [String(i+1), key ? localStorage.getItem(key) || '' : ''];
          })
          .filter(([,v])=>v && v.trim()!=='')
        ),
        goals: goalData
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `wizwealth90_${profile.name}_${new Date().toISOString().split('T')[0]}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function importState(file){
      if (!getCurrentProfile()) {
        alert('No profile selected. Create a profile first.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          // Validate data
          if (typeof data !== 'object' || !data.day) {
            throw new Error('Invalid file format');
          }
          
          if (data.day < 1 || data.day > 90) {
            throw new Error('Invalid day number');
          }
          
          const dayK = dayKey();
          if (data.day && dayK) localStorage.setItem(dayK, String(data.day));
          
          const themeK = themeKey();
          if (data.theme && themeK) {
            localStorage.setItem(themeK, data.theme);
            document.documentElement.setAttribute('data-theme', data.theme);
            updateThemeIcon(data.theme);
          }
          
          if (data.notes) {
            Object.entries(data.notes).forEach(([k,v])=>{
              const d = parseInt(k,10);
              const noteK = notesKey(d);
              if (d>=1 && d<=90 && noteK) {
                localStorage.setItem(noteK, v);
              }
            });
          }
          
          if (data.goals) {
            Object.entries(data.goals).forEach(([w,goals])=>{
              const week = parseInt(w,10);
              if (week>=1 && week<=13) saveGoals(week, goals);
            });
          }
          
          renderDay(getCurrentDay());
          alert('✅ Imported!');
        } catch(e){ 
          alert('❌ Invalid file: ' + e.message); 
        }
      };
      reader.readAsText(file);
    }

    // Handlers
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('btnNext').addEventListener('click', nextDay);
    document.getElementById('btnPrev').addEventListener('click', prevDay);
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if (file) importState(file);
      e.target.value = '';
    });
    document.getElementById('btnClearNotes').addEventListener('click', ()=>{
      if (confirm('Clear notes for this day?')){
        const d = getCurrentDay();
        localStorage.removeItem(notesKey(d));
        loadNotes(d);
      }
    });
    document.getElementById('notes').addEventListener('input', (e)=>{
      saveNotes(getCurrentDay());
      document.getElementById('charCount').textContent = e.target.value.length;
    });
    document.getElementById('newGoal').addEventListener('keypress', async (e)=>{
      if (e.key === 'Enter'){
        const week = getWeekNumber(getCurrentDay());
        await addGoal(week, e.target.value);
      }
    });
    
    // Done button handler
    document.getElementById('btnDone').addEventListener('click', ()=>{
      if (!getCurrentProfile()) return;
      const day = getCurrentDay();
      if (isDayDone(day)) return;
      
      markDayDone(day);
      updateDoneButton(day);
      updateStreakCounter();
      renderProgressCalendar();
      
      // Trigger animations
      const card = document.getElementById('dayCard');
      card.classList.add('donePulse');
      setTimeout(() => card.classList.remove('donePulse'), 600);
      
      toast(`✅ Day ${day} saved! All notes and progress stored.`);
    });
    
    // Mantra copy-to-clipboard
    document.getElementById('mantra').addEventListener('click', async ()=>{
      const mantraText = document.getElementById('mantra').textContent;
      if (!mantraText) return;
      
      try {
        await navigator.clipboard.writeText(mantraText);
        toast('📋 Mantra copied');
      } catch (err) {
        console.error('Failed to copy:', err);
        toast("⚠️ Couldn't copy");
      }
    });
    
    // Profile handlers
    document.getElementById('profileBtn').addEventListener('click', toggleProfileDropdown);
    document.getElementById('btnNewProfile').addEventListener('click', ()=>{
      toggleProfileDropdown();
      showProfileModal(false);
    });
    document.getElementById('modalConfirm').addEventListener('click', handleProfileCreate);
    document.getElementById('modalCancel').addEventListener('click', hideProfileModal);
    document.getElementById('profileNameInput').addEventListener('keypress', (e)=>{
      if (e.key === 'Enter') handleProfileCreate();
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e)=>{
      const dropdown = document.getElementById('profileDropdown');
      const btn = document.getElementById('profileBtn');
      if (!dropdown.contains(e.target) && !btn.contains(e.target)){
        dropdown.classList.remove('show');
      }
      
      // Close settings dropdown
      const settingsDropdown = document.getElementById('settingsDropdown');
      const settingsBtn = document.getElementById('settingsBtn');
      if (settingsDropdown && settingsBtn && !settingsDropdown.contains(e.target) && !settingsBtn.contains(e.target)){
        settingsDropdown.classList.remove('show');
      }
    });
    
    // ---- COLLAPSIBLE SECTIONS ----
    function initCollapsibleSections(){
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', ()=>{
          const section = header.getAttribute('data-section');
          const content = header.nextElementSibling;
          const toggle = header.querySelector('.collapsible-toggle');
          
          if (content.classList.contains('expanded')){
            content.classList.remove('expanded');
            toggle.classList.remove('expanded');
          } else {
            content.classList.add('expanded');
            toggle.classList.add('expanded');
          }
          
          // Save state
          const profile = getCurrentProfile();
          if (profile){
            const key = `${profile.id}.collapsed.${section}`;
            localStorage.setItem(key, content.classList.contains('expanded') ? 'expanded' : 'collapsed');
          }
        });
      });
      
      // Restore state (or set smart defaults)
      const profile = getCurrentProfile();
      const currentDay = getCurrentDay();
      if (profile){
        document.querySelectorAll('.collapsible-header').forEach(header => {
          const section = header.getAttribute('data-section');
          const key = `${profile.id}.collapsed.${section}`;
          const state = localStorage.getItem(key);
          const content = header.nextElementSibling;
          const toggle = header.querySelector('.collapsible-toggle');
          
          // Smart defaults after day 7
          let shouldExpand = true;
          if (state === null && currentDay > 7 && (section === 'routine' || section === 'evening')){
            shouldExpand = false; // Auto-collapse routine/evening after day 7
          } else if (state === 'expanded' || state === null){
            shouldExpand = true;
          } else {
            shouldExpand = false;
          }
          
          if (shouldExpand){
            content.classList.add('expanded');
            toggle.classList.add('expanded');
          }
        });
      }
    }
    
    // ---- V2 SCORE TRACKING ----
    function getV2ScoreKey(day){
      const profile = getCurrentProfile();
      if (!profile) return null;
      return `${profile.id}.v2score.${day}`;
    }
    
    function saveV2Score(day, score){
      const key = getV2ScoreKey(day);
      if (key) localStorage.setItem(key, String(score));
    }
    
    function loadV2Score(day){
      const key = getV2ScoreKey(day);
      return key ? parseInt(localStorage.getItem(key) || '5', 10) : 5;
    }
    
    function renderV2Sparkline(){
      const sparkline = document.getElementById('v2Sparkline');
      const avgEl = document.getElementById('v2Average');
      if (!sparkline) return;
      
      sparkline.innerHTML = '';
      const currentDay = getCurrentDay();
      const startDay = Math.max(1, currentDay - 6); // Last 7 days
      
      let total = 0;
      let count = 0;
      
      for(let day = startDay; day <= currentDay; day++){
        const score = loadV2Score(day);
        const bar = document.createElement('div');
        bar.className = 'v2-sparkline-bar';
        
        // Color coding
        if (score < 4) bar.classList.add('low');
        else if (score >= 4 && score <= 6) bar.classList.add('medium');
        else bar.classList.add('high');
        
        if (day === currentDay) bar.classList.add('today');
        bar.style.height = `${(score / 10) * 100}%`;
        bar.title = `Day ${day}: ${score}/10`;
        sparkline.appendChild(bar);
        
        total += score;
        count++;
      }
      
      // Update average
      if (avgEl && count > 0){
        const avg = (total / count).toFixed(1);
        avgEl.textContent = `Avg: ${avg}`;
      }
    }
    
    // V2 Score input handler
    document.getElementById('v2ScoreInput')?.addEventListener('input', (e)=>{
      const score = parseInt(e.target.value, 10);
      document.getElementById('v2ScoreValue').textContent = score;
      saveV2Score(getCurrentDay(), score);
      renderV2Sparkline();
      
      // Visual feedback
      const widget = e.target.closest('.v2-score-widget');
      widget.style.transform = 'scale(1.02)';
      setTimeout(() => widget.style.transform = 'scale(1)', 200);
    });
    
    function loadV2ScoreForDay(day){
      const score = loadV2Score(day);
      const input = document.getElementById('v2ScoreInput');
      const value = document.getElementById('v2ScoreValue');
      if (input) input.value = score;
      if (value) value.textContent = score;
      renderV2Sparkline();
    }
    
    // ---- PROGRESS CALENDAR ----
    function renderProgressCalendar(){
      const calendar = document.getElementById('progressCalendar');
      if (!calendar) return;
      
      calendar.innerHTML = '';
      const currentDay = getCurrentDay();
      const program = generateProgram();
      
      for(let day = 1; day <= 90; day++){
        const dayData = program[day - 1];
        const dayEl = document.createElement('div');
        dayEl.className = 'progress-day';
        dayEl.textContent = day;
        
        // Enhanced tooltip with phase and theme
        const weekNum = Math.floor((day - 1) / 7) + 1;
        dayEl.title = `Day ${day} • Week ${weekNum}\n${dayData.phase}\n${dayData.weekTheme}`;
        
        if (isDayDone(day)){
          dayEl.classList.add('done');
          dayEl.title += '\n✓ Done';
        }
        
        if (day === currentDay){
          dayEl.classList.add('current');
          dayEl.title += '\n(Today)';
        }
        
        dayEl.addEventListener('click', ()=>{
          renderDay(day);
        });
        
        calendar.appendChild(dayEl);
      }
    }
    
    // ---- SETTINGS MENU ----
    document.getElementById('settingsBtn')?.addEventListener('click', ()=>{
      document.getElementById('settingsDropdown').classList.toggle('show');
    });
    
    document.getElementById('btnExportSettings')?.addEventListener('click', ()=>{
      document.getElementById('settingsDropdown').classList.remove('show');
      exportState();
    });
    
    document.getElementById('btnImportSettings')?.addEventListener('click', ()=>{
      document.getElementById('settingsDropdown').classList.remove('show');
      document.getElementById('importFile').click();
    });
    
    document.getElementById('btnResetSettings')?.addEventListener('click', ()=>{
      document.getElementById('settingsDropdown').classList.remove('show');
      const profile = getCurrentProfile();
      if (!profile) {
        alert('No profile selected.');
        return;
      }
      
      if (confirm(`Reset day, theme, notes and goals for ${profile.name}?`)){
        for(let i=1;i<=90;i++) {
          const noteK = notesKey(i);
          if (noteK) localStorage.removeItem(noteK);
        }
        for(let w=1;w<=13;w++) {
          const goalK = goalsKey(w);
          if (goalK) localStorage.removeItem(goalK);
        }
        
        const dayK = dayKey();
        const themeK = themeKey();
        if (dayK) localStorage.setItem(dayK, '1');
        if (themeK) localStorage.setItem(themeK, 'dark');
        
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon('dark');
        renderDay(1);
        toast('✅ Reset complete');
      }
    });
    
    // ---- DAY DISPLAY CLICK (simplified navigation) ----
    document.getElementById('dayDisplay')?.addEventListener('click', ()=>{
      const input = document.getElementById('gotoDay');
      const day = parseInt(prompt('Go to day (1-90):', getCurrentDay()), 10);
      if (day && day >= 1 && day <= 90) renderDay(day);
    });
    
    // ---- STREAK COUNTER ----
    function updateStreakCounter(){
      const profile = getCurrentProfile();
      if (!profile) return;
      
      let streak = 0;
      const today = new Date().toDateString();
      const streakKey = `${profile.id}.streak`;
      const lastDoneKey = `${profile.id}.lastDoneDate`;
      
      // Calculate streak
      for(let i = getCurrentDay(); i >= 1; i--){
        if (isDayDone(i)){
          streak++;
        } else {
          break;
        }
      }
      
      const badge = document.getElementById('streakBadge');
      const count = document.getElementById('streakCount');
      
      if (streak > 0){
        badge.style.display = 'inline-flex';
        badge.style.background = 'linear-gradient(135deg, #ff6b6b, #ff8e53)';
        count.textContent = streak === 1 ? '1 day' : `${streak} days`;
      } else {
        badge.style.display = 'inline-flex';
        badge.style.background = 'linear-gradient(135deg, #f59e0b, #f97316)';
        count.textContent = '🔥 0 days - Start today!';
      }
    }
    
    // ---- ONBOARDING ----
    const onboardingSlides = [
      {
        title: 'Welcome to WizWealth90! 🎯',
        text: "This is a 90-day program to transform your wealth identity, inspired by Chris 'The Wiz' Miller. Every day, you'll get practical actions to shift how you show up."
      },
      {
        title: 'Focus on the First Domino 🎯',
        text: 'Each day highlights ONE "First Domino" action - the small move that creates momentum. This is your priority. Everything else supports it.'
      },
      {
        title: 'Track Your Progress ✨',
        text: 'Use the completion checklist to track your daily actions. Mark sections as done, and watch your streak grow. Consistency beats intensity.'
      },
      {
        title: 'Start Small, Build Daily 🚀',
        text: "You don't need to do everything perfectly. Just show up, do one thing, and let the identity shift happen naturally. Ready to begin?"
      }
    ];
    
    let currentOnboardingSlide = 0;
    
    function showOnboarding(){
      const hasSeenOnboarding = localStorage.getItem('wizwealth90.onboardingSeen');
      if (hasSeenOnboarding) return;
      
      document.getElementById('onboardingModal').classList.remove('hidden');
      updateOnboardingSlide();
    }
    
    function updateOnboardingSlide(){
      const slide = onboardingSlides[currentOnboardingSlide];
      document.getElementById('onboardingTitle').textContent = slide.title;
      document.getElementById('onboardingText').textContent = slide.text;
      
      // Update dots
      document.querySelectorAll('.onboarding-dot').forEach((dot, idx) => {
        if (idx === currentOnboardingSlide){
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
      
      // Update button
      const nextBtn = document.getElementById('onboardingNext');
      if (currentOnboardingSlide === onboardingSlides.length - 1){
        nextBtn.textContent = 'Get Started! 🎯';
      } else {
        nextBtn.textContent = 'Next →';
      }
    }
    
    document.getElementById('onboardingNext')?.addEventListener('click', ()=>{
      if (currentOnboardingSlide < onboardingSlides.length - 1){
        currentOnboardingSlide++;
        updateOnboardingSlide();
      } else {
        closeOnboarding();
      }
    });
    
    document.getElementById('onboardingSkip')?.addEventListener('click', closeOnboarding);
    
    function closeOnboarding(){
      document.getElementById('onboardingModal').classList.add('hidden');
      localStorage.setItem('wizwealth90.onboardingSeen', 'true');
      currentOnboardingSlide = 0;
    }
    
    // ---- MOBILE TABS ----
    document.querySelectorAll('.mobile-tab').forEach(tab => {
      tab.addEventListener('click', ()=>{
        const tabName = tab.getAttribute('data-tab');
        
        // Update active state
        document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show/hide content
        const dayCard = document.getElementById('dayCard');
        const aside = document.querySelector('aside.card');
        
        if (tabName === 'today'){
          dayCard.style.display = 'block';
          aside.style.display = 'none';
        } else if (tabName === 'goals'){
          dayCard.style.display = 'none';
          aside.style.display = 'block';
          // Scroll to goals
          document.querySelector('.goal-widget')?.scrollIntoView({behavior:'smooth'});
        } else if (tabName === 'notes'){
          dayCard.style.display = 'none';
          aside.style.display = 'block';
          // Scroll to notes
          document.getElementById('notes')?.scrollIntoView({behavior:'smooth'});
        }
      });
    });
    
    // Update day display text
    function updateDayDisplay(){
      const day = getCurrentDay();
      const week = getWeekNumber(day);
      document.getElementById('dayDisplayText').textContent = `Day ${day} of 90`;
    }
    
    // ---- TOOLTIP TOUCH SUPPORT ----
    function initTooltips(){
      document.querySelectorAll('.tooltip').forEach(tooltip => {
        tooltip.addEventListener('click', (e)=>{
          e.stopPropagation();
          const tooltiptext = tooltip.querySelector('.tooltiptext');
          if (!tooltiptext) return;
          
          // Toggle visibility
          const isVisible = tooltiptext.style.visibility === 'visible';
          
          // Hide all other tooltips first
          document.querySelectorAll('.tooltiptext').forEach(t => {
            t.style.visibility = 'hidden';
            t.style.opacity = '0';
          });
          
          // Show/hide this tooltip
          if (!isVisible){
            tooltiptext.style.visibility = 'visible';
            tooltiptext.style.opacity = '1';
          }
        });
      });
      
      // Close tooltips when clicking outside
      document.addEventListener('click', ()=>{
        document.querySelectorAll('.tooltiptext').forEach(t => {
          t.style.visibility = 'hidden';
          t.style.opacity = '0';
        });
      });
    }
    
    // ---- KEYBOARD SHORTCUTS ----
    document.addEventListener('keydown', (e)=>{
      // Ignore if user is typing in input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      if (e.key === 'ArrowRight'){
        e.preventDefault();
        const nextBtn = document.getElementById('btnNext');
        if (nextBtn && !nextBtn.disabled) nextBtn.click();
      } else if (e.key === 'ArrowLeft'){
        e.preventDefault();
        const prevBtn = document.getElementById('btnPrev');
        if (prevBtn && !prevBtn.disabled) prevBtn.click();
      }
    });

    // Boot
    (async function init(){
      const profile = getCurrentProfile();
      if (!profile){
        showProfileModal(true);
        return;
      }
      
      updateProfileDisplay();
      initTheme();
      initCollapsibleSections();
      initTooltips();
      if (!localStorage.getItem(dayKey())) localStorage.setItem(dayKey(), '1');
      await renderDay(getCurrentDay());
      updateStreakCounter();
      updateDayDisplay();
      showOnboarding();
    })();
  </script>
</body>
</html>

