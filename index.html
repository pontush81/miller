<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WizWealth90 – Chris "The Wiz" Miller Program</title>
  <meta name="description" content="90-dagars Wealth Identity Program i Miller-stil">
  <meta name="theme-color" content="#0b0f16">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#0b0f16; --card:#121826; --muted:#8ea0b5; --text:#e8eef7; 
      --acc:#7bd88f; --acc2:#8ab4ff; --border:#1c2635; --input:#152032;
      --hover:#2f466b; --pill:#0f1a2a; --pillBorder:#21314b;
      --mantraBg:#10192a; --mantraBorder:#8ab4ff; --textarea:#10192a;
      --textareaBorder:#1e2b44; --badge:#10263b; --badgeBorder:#234b73;
      --badgeText:#cde3ff; --warm:#ffd479;
    }
    [data-theme="light"] {
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b; --text:#111827;
      --acc:#10b981; --acc2:#3b82f6; --border:#e2e8f0; --input:#f1f5f9;
      --hover:#cbd5e1; --pill:#f8fafc; --pillBorder:#cbd5e1;
      --mantraBg:#eff6ff; --mantraBorder:#3b82f6; --textarea:#f8fafc;
      --textareaBorder:#cbd5e1; --badge:#dbeafe; --badgeBorder:#93c5fd;
      --badgeText:#1e40af; --warm:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;transition:background 0.3s, color 0.3s;letter-spacing:0.01em}
    
    /* Animations */
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(20px); }
      to { opacity:1; transform:translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(139, 180, 255, 0); }
      50% { box-shadow: 0 0 20px 5px rgba(139, 180, 255, 0.3); }
    }
    @keyframes themeRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .fade-in { animation: fadeInUp 0.6s ease-out; }
    header{position:sticky;top:0;background:var(--bg);z-index:5;padding:16px 20px 8px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .header-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    main{max-width:920px;margin:24px auto;padding:0 16px 60px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button, input[type="number"], select {border:1px solid var(--border);background:var(--input);color:var(--text);padding:8px 16px;border-radius:20px;cursor:pointer;transition:all 0.3s;font-weight:500}
    button:hover{border-color:var(--hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .theme-toggle{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:12px;cursor:pointer;font-size:18px;transition:all 0.3s}
    .theme-toggle:hover{border-color:var(--hover);transform:scale(1.05)}
    .theme-toggle.rotating{animation:themeRotate 0.5s ease-in-out}
    .pill{background:var(--pill);border:1px solid var(--pillBorder);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;transition:background 0.3s, border 0.3s;box-shadow:0 8px 24px rgba(0,0,0,0.1)}
    h2{font-size:20px;margin:0 0 12px;font-weight:600;letter-spacing:0.02em}
    h3{font-size:15px;margin:18px 0 10px;color:var(--text);opacity:0.9;font-weight:600;letter-spacing:0.03em}
    .kicker{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
    .big{font-size:15px}
    ul{margin:8px 0 0 18px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:var(--badge);border:1px solid var(--badgeBorder);color:var(--badgeText);padding:3px 8px;border-radius:8px;font-size:12px}
    .mantra{border-left:3px solid var(--mantraBorder);padding:12px 16px;background:var(--mantraBg);border-radius:12px;margin:6px 0;color:var(--text);font-weight:500;letter-spacing:0.02em;cursor:pointer;transition:all 0.3s;animation:mantraGlow 6s ease-in-out infinite}
    .mantra:hover{transform:scale(1.02);box-shadow:0 0 20px rgba(255,212,121,0.2)}
    .ok{color:var(--acc)}
    .danger{color:#ff8a8a}
    .hr{height:1px;background:linear-gradient(90deg, transparent, var(--border), transparent);margin:16px 0}
    
    /* Progress Bar */
    .progress-container{margin:12px 0 24px;padding:0}
    .progress-label{font-size:12px;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between;font-weight:500}
    .progress-bar{height:6px;background:var(--input);border-radius:10px;overflow:hidden;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg, var(--acc), var(--acc2));border-radius:10px;transition:width 0.6s ease-out;position:relative}
    .progress-fill::after{content:'';position:absolute;top:0;right:0;bottom:0;left:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation:shimmer 2s infinite}
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes mantraGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,212,121,0.08); }
      50% { box-shadow: 0 0 24px 0 rgba(255,212,121,0.14); }
    }
    @keyframes donePulse {
      0% { box-shadow: 0 0 0 0 rgba(123,216,143,0); }
      50% { box-shadow: 0 0 24px 2px rgba(123,216,143,0.25); }
      100% { box-shadow: 0 0 0 0 rgba(123,216,143,0); }
    }
    @keyframes fade {
      from { opacity:0; transform:translateY(4px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    /* Energy Symbol */
    .energy-badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg, rgba(123,216,143,0.1), rgba(138,180,255,0.1));border:1px solid var(--acc);padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:12px}
    .energy-symbol{font-size:20px}
    
    /* Wisdom Quote */
    .wisdom-quote{background:linear-gradient(135deg, var(--mantraBg), var(--input));border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-style:italic;color:var(--text);opacity:0.9;font-size:14px;line-height:1.6}
    .footer{font-size:12px;color:var(--muted);margin-top:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .small{font-size:12px}
    textarea{width:100%;min-height:110px;background:var(--textarea);color:var(--text);border:1px solid var(--textareaBorder);border-radius:10px;padding:10px;transition:background 0.3s, border 0.3s}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    a.link{color:var(--acc2)}
    .goal-widget{background:var(--mantraBg);border:1px solid var(--mantraBorder);border-radius:10px;padding:12px;margin:12px 0}
    .goal-input{width:100%;background:var(--textarea);border:1px solid var(--textareaBorder);color:var(--text);padding:8px;border-radius:8px;font-size:13px}
    .goal-list{list-style:none;padding:0;margin:8px 0 0}
    .goal-item{display:flex;gap:8px;align-items:center;padding:6px 0;font-size:13px}
    .goal-checkbox{width:16px;height:16px;cursor:pointer}
    .goal-completed{text-decoration:line-through;opacity:0.6}
    
    /* Toast notifications */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 16px;opacity:0;transition:opacity 0.3s;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:14px}
    .toast.show{opacity:1}
    
    /* Done button */
    #btnDone{background:var(--acc);color:var(--card);font-weight:600;margin-top:12px;width:100%;transition:all 0.3s}
    #btnDone:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(123,216,143,0.3)}
    #btnDone.completed{background:var(--input);color:var(--muted);cursor:default}
    #btnDone.completed:hover{transform:none;box-shadow:none}
    .fadeIn{animation:fade 0.25s ease}
    .donePulse{animation:donePulse 0.6s ease}
    
    /* Profile modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.4)}
    .modal h2{margin:0 0 12px;font-size:20px}
    .modal p{color:var(--muted);margin:0 0 16px;font-size:14px}
    .modal input{width:100%;padding:10px;background:var(--input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
    .modal-buttons{display:flex;gap:8px;justify-content:flex-end}
    .profile-selector{position:relative;display:inline-block}
    .profile-btn{display:flex;align-items:center;gap:6px;background:var(--input);border:1px solid var(--border);padding:6px 12px;border-radius:10px;cursor:pointer;font-size:13px}
    .profile-btn:hover{border-color:var(--hover)}
    .profile-dropdown{display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:10px;min-width:200px;box-shadow:0 8px 16px rgba(0,0,0,0.3);z-index:10}
    .profile-dropdown.show{display:block}
    .profile-item{padding:10px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border)}
    .profile-item:hover{background:var(--input)}
    .profile-item:last-child{border-bottom:none}
    .profile-item.active{color:var(--acc);font-weight:600}
    .profile-item.delete{color:var(--danger)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div>
        <h1>WizWealth90</h1>
        <div class="sub">Chris "The Wiz" Miller – 90-dagars Wealth Identity Program</div>
      </div>
      <div class="row">
        <div class="profile-selector">
          <button class="profile-btn" id="profileBtn" title="Byt profil">
            👤 <span id="currentProfile">Profil</span>
          </button>
          <div class="profile-dropdown" id="profileDropdown">
            <div id="profileList"></div>
            <div class="profile-item" id="btnNewProfile" style="border-top:1px solid var(--border)">+ Ny profil</div>
          </div>
        </div>
        <button class="theme-toggle" id="themeToggle" title="Byt tema">🌙</button>
      </div>
    </div>
  </header>
  
  <!-- Progress Bar -->
  <div class="progress-container" style="max-width:920px;margin:16px auto;padding:0 16px">
    <div class="progress-label">
      <span id="progressText">Dag 1 av 90 • Vecka 1</span>
      <span id="progressPercent">1%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:1%"></div>
    </div>
  </div>
  
  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="modalTitle">Välkommen! 👋</h2>
      <p id="modalDesc">Skapa din profil för att börja programmet. Flera personer kan använda samma enhet.</p>
      <input type="text" id="profileNameInput" placeholder="Ditt namn (t.ex. Anna, Johan...)" maxlength="30">
      <div class="modal-buttons">
        <button id="modalCancel" class="hidden">Avbryt</button>
        <button id="modalConfirm" class="ok">Skapa profil</button>
      </div>
    </div>
  </div>
  <main>
    <div class="toolbar row">
      <span class="pill">Kodord: <b>WizWealth90</b></span>
      <button id="btnPrev" title="Föregående dag">← Föregående</button>
      <button id="btnToday" style="background:var(--acc2);color:#fff;border-color:var(--acc2)" title="Visa sparad dag">Idag</button>
      <button id="btnNext" style="background:var(--acc);color:#0b0f16;border-color:var(--acc);font-weight:600" title="Nästa dag">Nästa dag →</button>
      <div class="row">
        <label class="small muted" for="gotoDay">Gå till dag:</label>
        <input id="gotoDay" type="number" min="1" max="90" style="width:84px">
        <button id="btnGoto">Gå</button>
      </div>
      <div class="grow"></div>
      <button id="btnExport">Exportera</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImport">Importera</button>
      <button id="btnReset" class="danger">Återställ</button>
    </div>

    <div class="grid">
      <section class="card fade-in" id="dayCard">
        <div class="kicker" id="kicker"></div>
        <h2 id="title"></h2>
        <div class="energy-badge" id="energyBadge">
          <span class="energy-symbol" id="energySymbol">⚡</span>
          <span id="energyText">Flow</span>
        </div>
        <div id="theme" class="badge"></div>
        <div class="hr"></div>
        <div class="wisdom-quote" id="wisdomQuote">"You are not here to fix yourself. You are here to remember."</div>
        <div id="pep" class="big"></div>
        <h3>🕒 10–15 min: Dagens Miller-rutin</h3>
        <ul id="routine"></ul>
        <h3>🎯 First Domino-idéer</h3>
        <ul id="domino"></ul>
        <h3>🌙 Kvällsdebrief</h3>
        <ul id="evening"></ul>
        <button id="btnDone" aria-label="Markera dagen som klar">✨ Markera dag som klar</button>
        <h3>💬 Dagens mantra</h3>
        <div id="mantra" class="mantra mono" title="Klicka för att kopiera"></div>
        <div class="footer">Din plats sparas automatiskt (lokalt i webbläsaren).</div>
      </section>

      <aside class="card">
        <h3>📆 Veckotema</h3>
        <div id="weekTheme" class="big"></div>
        
        <div class="hr"></div>
        <h3>🎯 Veckans mål</h3>
        <div class="goal-widget">
          <input type="text" class="goal-input" id="newGoal" placeholder="Lägg till veckans mål...">
          <ul class="goal-list" id="goalList"></ul>
        </div>
        
        <div class="hr"></div>
        <h3>🧰 Snabbverktyg</h3>
        <ul class="small">
          <li><b>Mikro-reset (30s):</b> Andas 4-2-6 + säg "Jag väljer överflöd nu".</li>
          <li><b>Kaffet som ankare:</b> Ta första klunken som om du redan är ekonomiskt fri.</li>
          <li><b>Intrycksdiet:</b> 10% mindre negativ input idag.</li>
        </ul>
        <div class="hr"></div>
        <h3>📝 Anteckningar</h3>
        <textarea id="notes" placeholder="Dina lärdomar idag..."></textarea>
        <div class="row small" style="margin-top:6px">
          <div class="grow muted">Sparas automatiskt lokalt</div>
          <button id="btnClearNotes">Rensa</button>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ---- Supabase Configuration ----
    const SUPABASE_URL = 'https://glqywwuchtpzehhuwbro.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXl3d3VjaHRwemVoaHV3YnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NzkxMjQsImV4cCI6MjA2OTU1NTEyNH0.XseH2QeuVShm-CEQdtvND1Yjp1IecA8Sg-dsqQMf1Qs';
    
    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // User ID management (anonymous mode)
    function getUserId() {
      let userId = localStorage.getItem('wizwealth90.userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('wizwealth90.userId', userId);
      }
      return userId;
    }
    
    // ---- Supabase Wrapper Functions ----
    
    // Daily Notes
    async function saveNoteToSupabase(day, content) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('daily_notes')
        .upsert({ 
          user_id: userId, 
          day: day, 
          content: content 
        }, { 
          onConflict: 'user_id,day' 
        });
      if (error) console.error('Error saving note:', error);
      return !error;
    }
    
    async function loadNoteFromSupabase(day) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('daily_notes')
        .select('content')
        .eq('user_id', userId)
        .eq('day', day)
        .single();
      if (error && error.code !== 'PGRST116') console.error('Error loading note:', error);
      return data?.content || '';
    }
    
    // Weekly Goals
    async function saveGoalsToSupabase(week, goals) {
      const userId = getUserId();
      
      // Delete existing goals for this week
      await sb
        .from('weekly_goals')
        .delete()
        .eq('user_id', userId)
        .eq('week', week);
      
      // Insert new goals
      if (goals.length > 0) {
        const goalsData = goals.map(goal => ({
          user_id: userId,
          week: week,
          goal_text: goal.text,
          completed: goal.completed
        }));
        
        const { error } = await sb
          .from('weekly_goals')
          .insert(goalsData);
        
        if (error) console.error('Error saving goals:', error);
      }
    }
    
    async function loadGoalsFromSupabase(week) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('weekly_goals')
        .select('*')
        .eq('user_id', userId)
        .eq('week', week)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading goals:', error);
        return [];
      }
      
      return data.map(g => ({
        text: g.goal_text,
        completed: g.completed
      }));
    }
    
    // Profile Data
    async function saveProfileToSupabase(profileData) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('profiles')
        .upsert({
          id: userId,
          name: profileData.name,
          current_day: profileData.currentDay,
          theme: profileData.theme
        }, {
          onConflict: 'id'
        });
      if (error) console.error('Error saving profile:', error);
      return !error;
    }
    
    async function loadProfileFromSupabase() {
      const userId = getUserId();
      const { data, error } = await sb
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();
      
      if (error && error.code !== 'PGRST116') console.error('Error loading profile:', error);
      return data;
    }
    
    const STORAGE_PROFILES = 'wizwealth90.profiles';
    const STORAGE_CURRENT_PROFILE = 'wizwealth90.currentProfile';
    const STORAGE_KEY_DAY = 'wizwealth90.day';
    const STORAGE_NOTES_PREFIX = 'wizwealth90.notes.';
    const STORAGE_THEME = 'wizwealth90.theme';
    const STORAGE_GOALS_PREFIX = 'wizwealth90.goals.';
    
    // ---- Profile Management ----
    function getAllProfiles(){
      const stored = localStorage.getItem(STORAGE_PROFILES);
      return stored ? JSON.parse(stored) : [];
    }
    
    function saveAllProfiles(profiles){
      localStorage.setItem(STORAGE_PROFILES, JSON.stringify(profiles));
    }
    
    function getCurrentProfile(){
      const id = localStorage.getItem(STORAGE_CURRENT_PROFILE);
      if (!id) return null;
      const profiles = getAllProfiles();
      return profiles.find(p => p.id === id) || null;
    }
    
    function setCurrentProfile(profileId){
      localStorage.setItem(STORAGE_CURRENT_PROFILE, profileId);
      updateProfileDisplay();
    }
    
    function createProfile(name){
      const profiles = getAllProfiles();
      const id = 'profile_' + Date.now();
      const newProfile = {
        id: id,
        name: name.trim(),
        createdAt: new Date().toISOString()
      };
      profiles.push(newProfile);
      saveAllProfiles(profiles);
      setCurrentProfile(id);
      return newProfile;
    }
    
    function deleteProfile(profileId){
      const profiles = getAllProfiles();
      const filtered = profiles.filter(p => p.id !== profileId);
      saveAllProfiles(filtered);
      
      // Clean up profile data
      for(let i=1; i<=90; i++){
        localStorage.removeItem(profileKey(profileId, STORAGE_NOTES_PREFIX + i));
      }
      for(let w=1; w<=13; w++){
        localStorage.removeItem(profileKey(profileId, STORAGE_GOALS_PREFIX + w));
      }
      localStorage.removeItem(profileKey(profileId, STORAGE_KEY_DAY));
      localStorage.removeItem(profileKey(profileId, STORAGE_THEME));
      
      // Switch to another profile or show modal
      if (filtered.length > 0){
        setCurrentProfile(filtered[0].id);
        renderDay(getCurrentDay());
      } else {
        localStorage.removeItem(STORAGE_CURRENT_PROFILE);
        showProfileModal(true);
      }
    }
    
    function profileKey(profileId, key){
      return `${profileId}.${key}`;
    }
    
    function updateProfileDisplay(){
      const profile = getCurrentProfile();
      if (profile){
        document.getElementById('currentProfile').textContent = profile.name;
      }
      renderProfileList();
    }
    
    function renderProfileList(){
      const profiles = getAllProfiles();
      const current = getCurrentProfile();
      const list = document.getElementById('profileList');
      list.innerHTML = '';
      
      // Add profile items
      profiles.forEach(profile => {
        const div = document.createElement('div');
        div.className = 'profile-item' + (profile.id === current?.id ? ' active' : '');
        div.textContent = profile.name;
        div.addEventListener('click', async () => {
          setCurrentProfile(profile.id);
          await renderDay(getCurrentDay());
          toggleProfileDropdown();
        });
        list.appendChild(div);
      });
      
      // Add delete options (if more than 1 profile)
      if (profiles.length > 1){
        profiles.forEach(profile => {
          const delDiv = document.createElement('div');
          delDiv.className = 'profile-item delete';
          delDiv.textContent = '🗑️ Ta bort ' + profile.name;
          delDiv.style.fontSize = '11px';
          delDiv.style.paddingLeft = '24px';
          delDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`Ta bort profil "${profile.name}"? All data för denna profil kommer raderas.`)){
              deleteProfile(profile.id);
            }
          });
          list.appendChild(delDiv);
        });
      }
    }
    
    function toggleProfileDropdown(){
      document.getElementById('profileDropdown').classList.toggle('show');
    }
    
    function showProfileModal(isFirst = false){
      document.getElementById('profileModal').classList.remove('hidden');
      document.getElementById('profileNameInput').value = '';
      document.getElementById('profileNameInput').focus();
      
      if (isFirst){
        document.getElementById('modalTitle').textContent = 'Välkommen! 👋';
        document.getElementById('modalDesc').textContent = 'Skapa din profil för att börja programmet. Flera personer kan använda samma enhet.';
        document.getElementById('modalCancel').classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = 'Skapa ny profil';
        document.getElementById('modalDesc').textContent = 'Varje profil har egen progress och anteckningar.';
        document.getElementById('modalCancel').classList.remove('hidden');
      }
    }
    
    function hideProfileModal(){
      document.getElementById('profileModal').classList.add('hidden');
    }
    
    async function handleProfileCreate(){
      const name = document.getElementById('profileNameInput').value.trim();
      if (!name){
        alert('Ange ett namn för profilen.');
        return;
      }
      
      createProfile(name);
      hideProfileModal();
      
      // Verify profile was created
      if (!getCurrentProfile()) {
        alert('Ett fel uppstod vid skapande av profil. Försök igen.');
        return;
      }
      
      // Initialize app after profile creation
      updateProfileDisplay();
      initTheme();
      
      const key = dayKey();
      if (key && !localStorage.getItem(key)) {
        localStorage.setItem(key, '1');
      }
      
      await renderDay(getCurrentDay());
    }

    function generateProgram(){
      const weeks = [
        {phase:'Self-Perception Reset', theme:'Jag är källan – inte siffrorna'},
        {phase:'Self-Perception Reset', theme:'Från oro → närvaro'},
        {phase:'Belief Encoding', theme:'Jag är rikedom'},
        {phase:'Belief Encoding', theme:'Känsla före bevis'},
        {phase:'Belief Encoding', theme:'V2-kvot & ankare'},
        {phase:'Belief Encoding', theme:'Synkronicitet & förtroende'},
        {phase:'Frequency Embodiment', theme:'Rör dig som rik'},
        {phase:'Frequency Embodiment', theme:'Wiz-30 = autopilot'},
        {phase:'Frequency Embodiment', theme:'Miljödesign för pengar'},
        {phase:'Frequency Embodiment', theme:'Lätthet skalar intäkter'},
        {phase:'Integration', theme:'Nya baslinjen etableras'},
        {phase:'Integration', theme:'Fira, förankra, förfina'},
        {phase:'Integration', theme:'Leva den nya standarden'}  // Week 13 (dag 85-90)
      ];

      const mantras = {
        reset:[
          'Jag är medvetenheten bakom allt.',
          'Oro är bara en gammal loop. Jag väljer överflöd.',
          'Jag är trygg i nuet; pengar rör sig till mig.',
          'Jag observerar – jag är inte mina tankar.'
        ],
        encode:[
          'Jag är en person som pengar dras till.',
          'Känslan är kvittot.',
          'Jag är rikedom i rörelse.',
          'Min närvaro skapar värde nu.'
        ],
        embody:[
          'Jag rör mig som rik.',
          'Lätthet tjänar mig ekonomiskt.',
          'Varje handling bär min nya identitet.',
          'Jag är standarden; pengar matchar mig.'
        ],
        integrate:[
          'Detta är min nya baseline.',
          'Jag förtjänar och tar emot.',
          'Jag väljer ro, jag väljer rikedom.',
          'Tacksamhet multiplicerar mitt flöde.'
        ]
      };

      const dominoPools = {
        reset:[
          'Kartlägg 3 pengar-oro-triggers & skriv om dem.',
          'Avsluta/avprenumerera på 1 negativ input.',
          'Skriv ett "tack gamla jag"-brev (5 min).',
          'Rensa en liten ekonomisk friktion (t.ex. onödig prenumeration).'
        ],
        encode:[
          'Skriv 5 "Jag är…" med känsla och spela in röst (lyssna ikväll).',
          'Skapa V2-bild i mobilen som bakgrund.',
          'Testa mikromanifestation: bjud in en oväntad komplimang/möjlighet.',
          'Formulera ditt 12-månaders "rik-ögonblick" i 3 meningar.'
        ],
        embody:[
          'Gör 1 reach-out (kund, partner, vän).',
          'Publicera 1 sak (post, inlägg, pitch, DM).',
          'Sälj något litet idag (pilot, rådgivning, paket).',
          'Delegera/automatisera 1 sak som dränerar energi.'
        ],
        integrate:[
          'Skriv lista över nya standards (minimi-beteenden).',
          'Fira 3 vinster – liten som stor.',
          'Planera 30–90 dagars "wealth ops"-förbättringar.',
          'Boka 1 belönande upplevelse för att förankra identiteten.'
        ]
      };

      const pep = {
        reset: [
          'Drick kaffet som om det redan är sant. Du är större än siffrorna.',
          'Oro är en kroppsvana – inte en framtidsprognos. Idag väljer du närvaro.',
          'Du behöver inte jaga – du ställer in signalen. Låt möjligheter hitta dig.',
          'Andas 4-2-6 och känn hur fältet blir tyst. Här skapas riktning.'
        ],
        encode: [
          'Känslan före bevis: låt kroppen känna "redan ägt".',
          'Affirmationer fungerar först när de känns. Välj en minnes-seger och tala därifrån.',
          'Du är personen som pengar söker upp. Kliv in i rummet som sådan.',
          'Öva mikromanifestation idag – låt världen nicka tillbaka.'
        ],
        embody: [
          'Rör dig som rik: enkel, tydlig, generös med fokus.',
          'Wiz-30 är din autopilot – tre små segrar räcker.',
          'Miljö före vilja: gör det lätt att göra rätt.',
          'Lätthet skalar intäkter. Jobba smart, inte tungt.'
        ],
        integrate: [
          'Detta är din nya baseline. Låt den synas i små val.',
          'Fira och förankra – det du firar upprepas.',
          'Sista kilometern formar vanan. Håll rytmen mjuk och stadig.',
          'Tacksamhet multiplicerar. Säg tack högt idag.'
        ]
      };

      const routineByPhase = {
        reset: [
          '2 min still awareness: jag observerar, jag är inte mina tankar.',
          '3 min skriv: Vad oroar mig? Hur svarar mitt rika jag?',
          '5 min revision: spela upp en ny scen där du agerar som V2.'
        ],
        encode: [
          '3 min "Jag är …" med känsla (5–7 rader).',
          '4 min scenvisualisering: ett konkret rik-ögonblick.',
          '2 min fysiskt ankare (hand mot hjärta + långsam andning).'
        ],
        embody: [
          '1 min kaffet som ankare – "det är redan mitt".',
          '7 min First Domino (liten handling mot intäkt).',
          '2 min V2-kvot: 0–10, vad gjorde skillnad?'
        ],
        integrate: [
          '3 min tacksamhet över bevisen du ser.',
          '5 min förfining: vad blir min nya minimi-standard?',
          '2 min plan för morgondagens First Domino.'
        ]
      };

      const evening = [
        'V2-kvot (0–10) & mikro-vinst.',
        'Vad triggade oro? Vad väljer jag nästa gång?',
        'Ett bevis på att flödet arbetar för mig.',
        'En sak jag förenklar/eliminera i morgon.'
      ];

      const days = [];
      for(let d=1; d<=90; d++){
        const weekIndex = Math.floor((d-1)/7);
        const wk = weeks[weekIndex];
        let phaseKey = 'reset';
        if (wk.phase.startsWith('Belief')) phaseKey = 'encode';
        else if (wk.phase.startsWith('Frequency')) phaseKey = 'embody';
        else if (wk.phase.startsWith('Integration')) phaseKey = 'integrate';

        const titles = {
          reset: ['Nollställ loopen','Närvaron leder','Du är källan','Andas, välj, skapa'],
          encode: ['Jag är rikedom','Känslan först','V2-kroppen leder','Öva bevis'],
          embody: ['Rör dig som rik','Wiz-30 = autopilot','Lätthet över kraft','Visa standarden'],
          integrate: ['Baslinje','Fira & förankra','Förfina standarden','Nya du stannar']
        };
        const title = titles[phaseKey][d % 4];
        const pepMsg = pep[phaseKey][d % pep[phaseKey].length];
        const mantra = ({
          reset: mantras.reset,
          encode: mantras.encode,
          embody: mantras.embody,
          integrate: mantras.integrate
        })[phaseKey][d % 4];

        const dom = ({
          reset: dominoPools.reset,
          encode: dominoPools.encode,
          embody: dominoPools.embody,
          integrate: dominoPools.integrate
        })[phaseKey];

        days.push({
          day: d,
          phase: wk.phase,
          weekTheme: wk.theme,
          title,
          pep: pepMsg,
          routine: routineByPhase[phaseKey],
          domino: [dom[d % dom.length], dom[(d+1) % dom.length], dom[(d+2) % dom.length]],
          evening,
          mantra
        });
      }
      return days;
    }

    const PROGRAM = generateProgram();
    
    // ---- Wisdom Quotes ----
    const WISDOM_QUOTES = [
      "You are not here to fix yourself. You are here to remember.",
      "Wealth is a frequency before it's a number.",
      "Your past doesn't equal your future unless you let it.",
      "The Universe doesn't respond to need. It responds to signal.",
      "You don't attract what you want. You attract who you are.",
      "Comfort is expensive. Clarity is free.",
      "Your nervous system is your wealth ceiling.",
      "You become the 5 identities you spend the most time in.",
      "Manifestation without embodiment is fantasy.",
      "Money loves speed and clarity.",
      "Your current results are yesterday's thoughts becoming today's reality.",
      "The gap between where you are and where you want to be is called 'practice'.",
      "You don't need more strategy. You need more sovereignty.",
      "Wealth is an inside job that shows up outside.",
      "Your breakthrough is on the other side of your pattern.",
      "Energy is currency. Spend it wisely.",
      "What you tolerate, you teach the Universe to send you more of.",
      "Your vibe is your tribe. Your frequency is your fortune.",
      "The fastest way to wealth is to become the person who already has it.",
      "You can't hustle your way into alignment.",
      "Trust the timing. Question the fear.",
      "Your next level requires a new level of you.",
      "Scarcity is learned. Abundance is your natural state.",
      "The Universe doesn't work for you. It works through you."
    ];
    
    // ---- Energy Symbols ----
    const ENERGY_SYMBOLS = [
      {symbol: '⚡', text: 'Flow', color: 'var(--acc)'},
      {symbol: '✨', text: 'Clarity', color: 'var(--acc2)'},
      {symbol: '🌊', text: 'Ease', color: 'var(--acc)'},
      {symbol: '🔥', text: 'Power', color: '#ff8a8a'},
      {symbol: '🌙', text: 'Trust', color: 'var(--acc2)'},
      {symbol: '💎', text: 'Value', color: 'var(--acc)'},
      {symbol: '🎯', text: 'Focus', color: 'var(--acc2)'},
      {symbol: '🌟', text: 'Shine', color: 'var(--acc)'}
    ];

    // ---- Theme ----
    function getWeekNumber(day){ return Math.floor((day-1)/7)+1; }
    function goalsKey(week){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_GOALS_PREFIX + week); 
    }
    function notesKey(day){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_NOTES_PREFIX + day); 
    }
    function dayKey(){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_KEY_DAY); 
    }
    function themeKey(){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_THEME); 
    }

    function initTheme(){
      const key = themeKey();
      const saved = key ? localStorage.getItem(key) || 'dark' : 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    function toggleTheme(){
      const key = themeKey();
      if (!key) return;
      
      // Add rotation animation
      const toggle = document.getElementById('themeToggle');
      toggle.classList.add('rotating');
      setTimeout(() => toggle.classList.remove('rotating'), 500);
      
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(key, next);
      updateThemeIcon(next);
    }

    function updateThemeIcon(theme){
      document.getElementById('themeToggle').textContent = theme === 'dark' ? '☀️' : '🌙';
    }

    // ---- Goals ----
    async function loadGoals(week){
      // Try Supabase first
      const supabGoals = await loadGoalsFromSupabase(week);
      if (supabGoals && supabGoals.length > 0) {
        return supabGoals;
      }
      
      // Fallback to localStorage
      const stored = localStorage.getItem(goalsKey(week));
      return stored ? JSON.parse(stored) : [];
    }

    async function saveGoals(week, goals){
      // Save to both Supabase and localStorage
      await saveGoalsToSupabase(week, goals);
      localStorage.setItem(goalsKey(week), JSON.stringify(goals));
    }

    async function renderGoals(week){
      const goals = await loadGoals(week);
      const list = document.getElementById('goalList');
      list.innerHTML = '';
      
      goals.forEach((goal, idx) => {
        const li = document.createElement('li');
        li.className = 'goal-item';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'goal-checkbox';
        cb.checked = goal.completed;
        cb.addEventListener('change', async ()=>{
          goals[idx].completed = cb.checked;
          await saveGoals(week, goals);
          await renderGoals(week);
        });
        
        const span = document.createElement('span');
        span.textContent = goal.text;
        span.className = goal.completed ? 'goal-completed' : '';
        
        li.appendChild(cb);
        li.appendChild(span);
        list.appendChild(li);
      });
    }

    async function addGoal(week, text){
      if (!text.trim()) return;
      const goals = await loadGoals(week);
      goals.push({text: text.trim(), completed: false});
      await saveGoals(week, goals);
      await renderGoals(week);
      document.getElementById('newGoal').value = '';
    }

    // ---- Toast Notifications ----
    function toast(msg){ 
      let t = document.querySelector('.toast'); 
      if(!t){ 
        t = document.createElement('div'); 
        t.className = 'toast'; 
        document.body.appendChild(t); 
      }
      t.textContent = msg; 
      t.classList.add('show'); 
      setTimeout(() => t.classList.remove('show'), 1500);
    }

    // ---- Done State ----
    function getDoneKey(day){
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, 'wizwealth90.done.' + day);
    }

    function isDayDone(day){
      const key = getDoneKey(day);
      if (!key) return false;
      return localStorage.getItem(key) === '1';
    }

    function markDayDone(day){
      const key = getDoneKey(day);
      if (!key) return;
      localStorage.setItem(key, '1');
    }

    function updateDoneButton(day){
      const btn = document.getElementById('btnDone');
      if (!btn) return;
      
      if (isDayDone(day)){
        btn.textContent = '✓ Dagen klar';
        btn.classList.add('completed');
        btn.disabled = true;
      } else {
        btn.textContent = '✨ Markera dag som klar';
        btn.classList.remove('completed');
        btn.disabled = false;
      }
    }

    // ---- UI helpers ----
    const el = (id)=>document.getElementById(id);
    
    function getCurrentDay(){
      const key = dayKey();
      const v = parseInt(key ? localStorage.getItem(key) || '1' : '1', 10);
      return isNaN(v)?1:Math.max(1, Math.min(90, v));
    }

    async function renderDay(n){
      if (!getCurrentProfile()) return; // Guard: no profile
      
      n = Math.max(1, Math.min(90, n));
      const key = dayKey();
      if (key) localStorage.setItem(key, String(n));
      
      const d = PROGRAM[n-1];
      const week = getWeekNumber(d.day);
      const kicker = `Dag ${d.day} • Vecka ${week} • ${d.phase}`;
      
      // Progress bar
      const progress = Math.round((n / 90) * 100);
      el('progressText').textContent = `Dag ${n} av 90 • Vecka ${week}`;
      el('progressPercent').textContent = `${progress}%`;
      const progressBar = el('progressFill');
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('role', 'progressbar');
      progressBar.setAttribute('aria-valuemin', '1');
      progressBar.setAttribute('aria-valuemax', '90');
      progressBar.setAttribute('aria-valuenow', String(n));
      
      // Energy symbol (rotate based on day)
      const energy = ENERGY_SYMBOLS[n % ENERGY_SYMBOLS.length];
      el('energySymbol').textContent = energy.symbol;
      el('energyText').textContent = energy.text;
      el('energyBadge').style.borderColor = energy.color;
      
      // Wisdom quote (rotate based on day)
      const wisdom = WISDOM_QUOTES[n % WISDOM_QUOTES.length];
      el('wisdomQuote').textContent = `"${wisdom}"`;

      el('kicker').textContent = kicker;
      el('title').textContent = d.title;
      el('theme').textContent = d.phase + ' • ' + d.weekTheme;
      el('weekTheme').textContent = d.weekTheme;
      el('pep').textContent = d.pep;

      const ulR = el('routine'); ulR.innerHTML='';
      d.routine.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulR.appendChild(li); });

      const ulD = el('domino'); ulD.innerHTML='';
      d.domino.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulD.appendChild(li); });

      const ulE = el('evening'); ulE.innerHTML='';
      d.evening.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulE.appendChild(li); });

      el('mantra').textContent = d.mantra || '';
      
      // Trigger fade-in animation
      const card = el('dayCard');
      card.classList.remove('fade-in');
      void card.offsetWidth; // Force reflow
      card.classList.add('fade-in');
      
      await loadNotes(n);
      await renderGoals(week);
      updateDoneButton(n);
    }

    function nextDay(){ 
      if (!getCurrentProfile()) return;
      renderDay(getCurrentDay()+1); 
    }
    function prevDay(){ 
      if (!getCurrentProfile()) return;
      renderDay(getCurrentDay()-1); 
    }

    async function saveNotes(day){ 
      const content = el('notes').value;
      await saveNoteToSupabase(day, content);
      
      // Also save to localStorage as backup
      const key = notesKey(day);
      if (key) localStorage.setItem(key, content);
    }
    
    async function loadNotes(day){ 
      // Try Supabase first, fallback to localStorage
      const supabContent = await loadNoteFromSupabase(day);
      
      if (supabContent) {
        el('notes').value = supabContent;
      } else {
        // Fallback to localStorage
        const key = notesKey(day);
        el('notes').value = key ? localStorage.getItem(key) || '' : '';
      }
    }

    // Export/import state (day + notes + goals)
    function exportState(){
      const profile = getCurrentProfile();
      if (!profile) {
        alert('Ingen profil vald. Skapa en profil först.');
        return;
      }
      
      const goalData = {};
      for(let w=1; w<=13; w++){
        const goals = loadGoals(w);
        if (goals.length > 0) goalData[w] = goals;
      }
      
      const themeK = themeKey();
      const data = {
        profileName: profile.name,
        day: getCurrentDay(),
        theme: themeK ? localStorage.getItem(themeK) || 'dark' : 'dark',
        notes: Object.fromEntries(
          Array.from({length:90}, (_,i)=>{
            const key = notesKey(i+1);
            return [String(i+1), key ? localStorage.getItem(key) || '' : ''];
          })
          .filter(([,v])=>v && v.trim()!=='')
        ),
        goals: goalData
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `wizwealth90_${profile.name}_${new Date().toISOString().split('T')[0]}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function importState(file){
      if (!getCurrentProfile()) {
        alert('Ingen profil vald. Skapa en profil först.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          // Validate data
          if (typeof data !== 'object' || !data.day) {
            throw new Error('Invalid file format');
          }
          
          if (data.day < 1 || data.day > 90) {
            throw new Error('Invalid day number');
          }
          
          const dayK = dayKey();
          if (data.day && dayK) localStorage.setItem(dayK, String(data.day));
          
          const themeK = themeKey();
          if (data.theme && themeK) {
            localStorage.setItem(themeK, data.theme);
            document.documentElement.setAttribute('data-theme', data.theme);
            updateThemeIcon(data.theme);
          }
          
          if (data.notes) {
            Object.entries(data.notes).forEach(([k,v])=>{
              const d = parseInt(k,10);
              const noteK = notesKey(d);
              if (d>=1 && d<=90 && noteK) {
                localStorage.setItem(noteK, v);
              }
            });
          }
          
          if (data.goals) {
            Object.entries(data.goals).forEach(([w,goals])=>{
              const week = parseInt(w,10);
              if (week>=1 && week<=13) saveGoals(week, goals);
            });
          }
          
          renderDay(getCurrentDay());
          alert('✅ Importerad!');
        } catch(e){ 
          alert('❌ Ogiltig fil: ' + e.message); 
        }
      };
      reader.readAsText(file);
    }

    // Handlers
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('btnNext').addEventListener('click', nextDay);
    document.getElementById('btnPrev').addEventListener('click', prevDay);
    document.getElementById('btnToday').addEventListener('click', ()=>renderDay(getCurrentDay()));
    document.getElementById('btnGoto').addEventListener('click', ()=>{
      const n = parseInt(document.getElementById('gotoDay').value, 10);
      if (!isNaN(n)) renderDay(n);
    });
    document.getElementById('btnReset').addEventListener('click', ()=>{
      const profile = getCurrentProfile();
      if (!profile) {
        alert('Ingen profil vald.');
        return;
      }
      
      if (confirm(`Nollställ dag, tema, anteckningar och mål för ${profile.name}?`)){
        for(let i=1;i<=90;i++) {
          const noteK = notesKey(i);
          if (noteK) localStorage.removeItem(noteK);
        }
        for(let w=1;w<=13;w++) {
          const goalK = goalsKey(w);
          if (goalK) localStorage.removeItem(goalK);
        }
        
        const dayK = dayKey();
        const themeK = themeKey();
        if (dayK) localStorage.setItem(dayK, '1');
        if (themeK) localStorage.setItem(themeK, 'dark');
        
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon('dark');
        renderDay(1);
      }
    });
    document.getElementById('btnExport').addEventListener('click', exportState);
    document.getElementById('btnImport').addEventListener('click', ()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if (file) importState(file);
      e.target.value = '';
    });
    document.getElementById('btnClearNotes').addEventListener('click', ()=>{
      if (confirm('Rensa anteckningar för denna dag?')){
        const d = getCurrentDay();
        localStorage.removeItem(notesKey(d));
        loadNotes(d);
      }
    });
    document.getElementById('notes').addEventListener('input', ()=>saveNotes(getCurrentDay()));
    document.getElementById('newGoal').addEventListener('keypress', async (e)=>{
      if (e.key === 'Enter'){
        const week = getWeekNumber(getCurrentDay());
        await addGoal(week, e.target.value);
      }
    });
    
    // Done button handler
    document.getElementById('btnDone').addEventListener('click', ()=>{
      if (!getCurrentProfile()) return;
      const day = getCurrentDay();
      if (isDayDone(day)) return;
      
      markDayDone(day);
      updateDoneButton(day);
      
      // Trigger animations
      const card = document.getElementById('dayCard');
      card.classList.add('donePulse');
      setTimeout(() => card.classList.remove('donePulse'), 600);
      
      toast('✨ Dagen integrerad');
    });
    
    // Mantra copy-to-clipboard
    document.getElementById('mantra').addEventListener('click', async ()=>{
      const mantraText = document.getElementById('mantra').textContent;
      if (!mantraText) return;
      
      try {
        await navigator.clipboard.writeText(mantraText);
        toast('📋 Mantra kopierat');
      } catch (err) {
        console.error('Failed to copy:', err);
        toast('⚠️ Kunde inte kopiera');
      }
    });
    
    // Profile handlers
    document.getElementById('profileBtn').addEventListener('click', toggleProfileDropdown);
    document.getElementById('btnNewProfile').addEventListener('click', ()=>{
      toggleProfileDropdown();
      showProfileModal(false);
    });
    document.getElementById('modalConfirm').addEventListener('click', handleProfileCreate);
    document.getElementById('modalCancel').addEventListener('click', hideProfileModal);
    document.getElementById('profileNameInput').addEventListener('keypress', (e)=>{
      if (e.key === 'Enter') handleProfileCreate();
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e)=>{
      const dropdown = document.getElementById('profileDropdown');
      const btn = document.getElementById('profileBtn');
      if (!dropdown.contains(e.target) && !btn.contains(e.target)){
        dropdown.classList.remove('show');
      }
    });

    // Boot
    (async function init(){
      const profile = getCurrentProfile();
      if (!profile){
        showProfileModal(true);
        return;
      }
      
      updateProfileDisplay();
      initTheme();
      if (!localStorage.getItem(dayKey())) localStorage.setItem(dayKey(), '1');
      await renderDay(getCurrentDay());
    })();
  </script>
</body>
</html>

