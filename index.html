<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WizWealth90 – Chris "The Wiz" Miller Program</title>
  <meta name="description" content="90-Day Wealth Identity Program in the style of Chris Miller">
  <meta name="theme-color" content="#0b0f16">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#0b0f16; --card:#121826; --muted:#8ea0b5; --text:#e8eef7; 
      --acc:#7bd88f; --acc2:#8ab4ff; --border:#1c2635; --input:#152032;
      --hover:#2f466b; --pill:#0f1a2a; --pillBorder:#21314b;
      --mantraBg:#10192a; --mantraBorder:#8ab4ff; --textarea:#10192a;
      --textareaBorder:#1e2b44; --badge:#10263b; --badgeBorder:#234b73;
      --badgeText:#cde3ff; --warm:#ffd479;
    }
    [data-theme="light"] {
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b; --text:#111827;
      --acc:#10b981; --acc2:#3b82f6; --border:#e2e8f0; --input:#f1f5f9;
      --hover:#cbd5e1; --pill:#f8fafc; --pillBorder:#cbd5e1;
      --mantraBg:#eff6ff; --mantraBorder:#3b82f6; --textarea:#f8fafc;
      --textareaBorder:#cbd5e1; --badge:#dbeafe; --badgeBorder:#93c5fd;
      --badgeText:#1e40af; --warm:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;transition:background 0.3s, color 0.3s;letter-spacing:0.01em}
    
    /* Animations */
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(20px); }
      to { opacity:1; transform:translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(139, 180, 255, 0); }
      50% { box-shadow: 0 0 20px 5px rgba(139, 180, 255, 0.3); }
    }
    @keyframes themeRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .fade-in { animation: fadeInUp 0.6s ease-out; }
    header{position:sticky;top:0;background:var(--bg);z-index:5;padding:16px 20px 8px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .header-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    main{max-width:920px;margin:24px auto;padding:0 16px 60px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button, input[type="number"], select {border:1px solid var(--border);background:var(--input);color:var(--text);padding:8px 16px;border-radius:20px;cursor:pointer;transition:all 0.3s;font-weight:500}
    button:hover{border-color:var(--hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .theme-toggle{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:12px;cursor:pointer;font-size:18px;transition:all 0.3s}
    .theme-toggle:hover{border-color:var(--hover);transform:scale(1.05)}
    .theme-toggle.rotating{animation:themeRotate 0.5s ease-in-out}
    .pill{background:var(--pill);border:1px solid var(--pillBorder);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;transition:background 0.3s, border 0.3s;box-shadow:0 8px 24px rgba(0,0,0,0.1)}
    h2{font-size:20px;margin:0 0 12px;font-weight:600;letter-spacing:0.02em}
    h3{font-size:15px;margin:18px 0 10px;color:var(--text);opacity:0.9;font-weight:600;letter-spacing:0.03em}
    .kicker{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
    .big{font-size:15px}
    ul{margin:8px 0 0 18px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:var(--badge);border:1px solid var(--badgeBorder);color:var(--badgeText);padding:3px 8px;border-radius:8px;font-size:12px}
    .mantra{border-left:3px solid var(--mantraBorder);padding:12px 16px;background:var(--mantraBg);border-radius:12px;margin:6px 0;color:var(--text);font-weight:500;letter-spacing:0.02em;cursor:pointer;transition:all 0.3s;animation:mantraGlow 6s ease-in-out infinite}
    .mantra:hover{transform:scale(1.02);box-shadow:0 0 20px rgba(255,212,121,0.2)}
    .ok{color:var(--acc)}
    .danger{color:#ff8a8a}
    .hr{height:1px;background:linear-gradient(90deg, transparent, var(--border), transparent);margin:16px 0}
    
    /* Progress Bar */
    .progress-container{margin:12px 0 24px;padding:0}
    .progress-label{font-size:12px;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between;font-weight:500}
    .progress-bar{height:6px;background:var(--input);border-radius:10px;overflow:hidden;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg, var(--acc), var(--acc2));border-radius:10px;transition:width 0.6s ease-out;position:relative}
    .progress-fill::after{content:'';position:absolute;top:0;right:0;bottom:0;left:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation:shimmer 2s infinite}
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes mantraGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,212,121,0.08); }
      50% { box-shadow: 0 0 24px 0 rgba(255,212,121,0.14); }
    }
    @keyframes donePulse {
      0% { box-shadow: 0 0 0 0 rgba(123,216,143,0); }
      50% { box-shadow: 0 0 24px 2px rgba(123,216,143,0.25); }
      100% { box-shadow: 0 0 0 0 rgba(123,216,143,0); }
    }
    @keyframes fade {
      from { opacity:0; transform:translateY(4px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    /* Energy Symbol */
    .energy-badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg, rgba(123,216,143,0.1), rgba(138,180,255,0.1));border:1px solid var(--acc);padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:12px}
    .energy-symbol{font-size:20px}
    
    /* Wisdom Quote */
    .wisdom-quote{background:linear-gradient(135deg, var(--mantraBg), var(--input));border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-style:italic;color:var(--text);opacity:0.9;font-size:14px;line-height:1.6}
    .footer{font-size:12px;color:var(--muted);margin-top:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .small{font-size:12px}
    textarea{width:100%;min-height:110px;background:var(--textarea);color:var(--text);border:1px solid var(--textareaBorder);border-radius:10px;padding:10px;transition:background 0.3s, border 0.3s}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    a.link{color:var(--acc2)}
    .goal-widget{background:var(--mantraBg);border:1px solid var(--mantraBorder);border-radius:10px;padding:12px;margin:12px 0}
    .goal-input{width:100%;background:var(--textarea);border:1px solid var(--textareaBorder);color:var(--text);padding:8px;border-radius:8px;font-size:13px}
    .goal-list{list-style:none;padding:0;margin:8px 0 0}
    .goal-item{display:flex;gap:8px;align-items:center;padding:6px 0;font-size:13px}
    .goal-checkbox{width:16px;height:16px;cursor:pointer;flex-shrink:0}
    .goal-text{flex:1;cursor:text;padding:2px 6px;border-radius:4px;transition:background 0.2s}
    .goal-text:hover{background:var(--hover)}
    .goal-text:focus{outline:none;background:var(--input);box-shadow:0 0 0 1px var(--acc2)}
    .goal-completed{text-decoration:line-through;opacity:0.6}
    .goal-delete{background:transparent;border:none;cursor:pointer;font-size:16px;opacity:0.5;transition:all 0.2s;padding:4px;flex-shrink:0}
    .goal-delete:hover{opacity:1;transform:scale(1.2)}
    
    /* Toast notifications */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 16px;opacity:0;transition:opacity 0.3s;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:14px}
    .toast.show{opacity:1}
    
    /* Done button */
    #btnDone{background:var(--acc);color:var(--card);font-weight:600;margin-top:12px;width:100%;transition:all 0.3s}
    #btnDone:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(123,216,143,0.3)}
    #btnDone.completed{background:var(--input);color:var(--muted);cursor:default}
    #btnDone.completed:hover{transform:none;box-shadow:none}
    .fadeIn{animation:fade 0.25s ease}
    .donePulse{animation:donePulse 0.6s ease}
    
    /* Profile modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.4)}
    .modal h2{margin:0 0 12px;font-size:20px}
    .modal p{color:var(--muted);margin:0 0 16px;font-size:14px}
    .modal input{width:100%;padding:10px;background:var(--input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
    .modal-buttons{display:flex;gap:8px;justify-content:flex-end}
    .profile-selector{position:relative;display:inline-block}
    .profile-btn{display:flex;align-items:center;gap:6px;background:var(--input);border:1px solid var(--border);padding:6px 12px;border-radius:10px;cursor:pointer;font-size:13px}
    .profile-btn:hover{border-color:var(--hover)}
    .profile-dropdown{display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:10px;min-width:200px;box-shadow:0 8px 16px rgba(0,0,0,0.3);z-index:10}
    .profile-dropdown.show{display:block}
    .profile-item{padding:10px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border)}
    .profile-item:hover{background:var(--input)}
    .profile-item:last-child{border-bottom:none}
    .profile-item.active{color:var(--acc);font-weight:600}
    .profile-item.delete{color:var(--danger)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div>
        <h1>WizWealth90</h1>
        <div class="sub">Chris "The Wiz" Miller – 90‑Day Wealth Identity Program</div>
      </div>
      <div class="row">
        <div class="profile-selector">
          <button class="profile-btn" id="profileBtn" title="Switch profile">
            👤 <span id="currentProfile">Profile</span>
          </button>
          <div class="profile-dropdown" id="profileDropdown">
            <div id="profileList"></div>
            <div class="profile-item" id="btnNewProfile" style="border-top:1px solid var(--border)">+ New profile</div>
          </div>
        </div>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">🌙</button>
      </div>
    </div>
  </header>
  
  <!-- Progress Bar -->
  <div class="progress-container" style="max-width:920px;margin:16px auto;padding:0 16px">
    <div class="progress-label">
      <span id="progressText">Day 1 of 90 • Week 1</span>
      <span id="progressPercent">1%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:1%"></div>
    </div>
  </div>
  
  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="modalTitle">Welcome! 👋</h2>
      <p id="modalDesc">Create your profile to start the program. Multiple people can use the same device.</p>
      <input type="text" id="profileNameInput" placeholder="Your name (e.g., Anna, John…)" maxlength="30">
      <div class="modal-buttons">
        <button id="modalCancel" class="hidden">Cancel</button>
        <button id="modalConfirm" class="ok">Create profile</button>
      </div>
    </div>
  </div>
  <main>
    <div class="toolbar row">
      <span class="pill">Codeword: <b>WizWealth90</b></span>
      <button id="btnPrev" title="Previous day">← Previous</button>
      <button id="btnToday" style="background:var(--acc2);color:#fff;border-color:var(--acc2)" title="Go to saved day">Today</button>
      <button id="btnNext" style="background:var(--acc);color:#0b0f16;border-color:var(--acc);font-weight:600" title="Next day">Next day →</button>
      <div class="row">
        <label class="small muted" for="gotoDay">Go to day:</label>
        <input id="gotoDay" type="number" min="1" max="90" style="width:84px">
        <button id="btnGoto">Go</button>
      </div>
      <div class="grow"></div>
      <button id="btnExport">Export</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImport">Import</button>
      <button id="btnReset" class="danger">Reset</button>
    </div>

    <div class="grid">
      <section class="card fade-in" id="dayCard">
        <div class="kicker" id="kicker"></div>
        <h2 id="title"></h2>
        <div class="energy-badge" id="energyBadge">
          <span class="energy-symbol" id="energySymbol">⚡</span>
          <span id="energyText">Flow</span>
        </div>
        <div id="theme" class="badge"></div>
        <div class="hr"></div>
        <div class="wisdom-quote" id="wisdomQuote">"You are not here to fix yourself. You are here to remember."</div>
        <div id="pep" class="big"></div>
        <h3>🕒 10–15 min: Daily Miller routine</h3>
        <ul id="routine"></ul>
        <h3>🎯 First Domino ideas</h3>
        <ul id="domino"></ul>
        <h3>🌙 Evening debrief</h3>
        <ul id="evening"></ul>
        <button id="btnDone" aria-label="Mark day as done">✨ Mark day as done</button>
        <h3>💬 Daily mantra</h3>
        <div id="mantra" class="mantra mono" title="Click to copy"></div>
        <div class="footer">Your place is saved automatically (in your browser).</div>
      </section>

      <aside class="card">
        <h3>📆 Weekly theme</h3>
        <div id="weekTheme" class="big"></div>
        
        <div class="hr"></div>
        <h3>🎯 Weekly goals</h3>
        <div class="goal-widget">
          <input type="text" class="goal-input" id="newGoal" placeholder="Add a weekly goal and press Enter…">
          <ul class="goal-list" id="goalList"></ul>
        </div>
        
        <div class="hr"></div>
        <h3>🧰 Quick tools</h3>
        <ul class="small">
          <li><b>Micro-reset (30s):</b> Breathe 4-2-6 + say "I choose abundance now".</li>
          <li><b>Coffee anchor:</b> Take the first sip as if you were already financially free.</li>
          <li><b>Input diet:</b> 10% less negative input today.</li>
        </ul>
        <div class="hr"></div>
        <h3>📝 Notes</h3>
        <textarea id="notes" placeholder="Your insights today…"></textarea>
        <div class="row small" style="margin-top:6px">
          <div class="grow muted">Autosaved locally</div>
          <button id="btnClearNotes">Clear</button>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ---- Supabase Configuration ----
    const SUPABASE_URL = 'https://glqywwuchtpzehhuwbro.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXl3d3VjaHRwemVoaHV3YnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NzkxMjQsImV4cCI6MjA2OTU1NTEyNH0.XseH2QeuVShm-CEQdtvND1Yjp1IecA8Sg-dsqQMf1Qs';
    
    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // User ID management (anonymous mode)
    function getUserId() {
      let userId = localStorage.getItem('wizwealth90.userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('wizwealth90.userId', userId);
      }
      return userId;
    }
    
    // ---- Supabase Wrapper Functions ----
    
    // Daily Notes
    async function saveNoteToSupabase(day, content) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('daily_notes')
        .upsert({ 
          user_id: userId, 
          day: day, 
          content: content 
        }, { 
          onConflict: 'user_id,day' 
        });
      if (error) console.error('Error saving note:', error);
      return !error;
    }
    
    async function loadNoteFromSupabase(day) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('daily_notes')
        .select('content')
        .eq('user_id', userId)
        .eq('day', day)
        .single();
      if (error && error.code !== 'PGRST116') console.error('Error loading note:', error);
      return data?.content || '';
    }
    
    // Weekly Goals
    async function saveGoalsToSupabase(week, goals) {
      const userId = getUserId();
      
      // Delete existing goals for this week
      await sb
        .from('weekly_goals')
        .delete()
        .eq('user_id', userId)
        .eq('week', week);
      
      // Insert new goals
      if (goals.length > 0) {
        const goalsData = goals.map(goal => ({
          user_id: userId,
          week: week,
          goal_text: goal.text,
          completed: goal.completed
        }));
        
        const { error } = await sb
          .from('weekly_goals')
          .insert(goalsData);
        
        if (error) console.error('Error saving goals:', error);
      }
    }
    
    async function loadGoalsFromSupabase(week) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('weekly_goals')
        .select('*')
        .eq('user_id', userId)
        .eq('week', week)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading goals:', error);
        return [];
      }
      
      return data.map(g => ({
        text: g.goal_text,
        completed: g.completed
      }));
    }
    
    // Profile Data
    async function saveProfileToSupabase(profileData) {
      const userId = getUserId();
      const { data, error } = await sb
        .from('profiles')
        .upsert({
          id: userId,
          name: profileData.name,
          current_day: profileData.currentDay,
          theme: profileData.theme
        }, {
          onConflict: 'id'
        });
      if (error) console.error('Error saving profile:', error);
      return !error;
    }
    
    async function loadProfileFromSupabase() {
      const userId = getUserId();
      const { data, error } = await sb
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();
      
      if (error && error.code !== 'PGRST116') console.error('Error loading profile:', error);
      return data;
    }
    
    const STORAGE_PROFILES = 'wizwealth90.profiles';
    const STORAGE_CURRENT_PROFILE = 'wizwealth90.currentProfile';
    const STORAGE_KEY_DAY = 'wizwealth90.day';
    const STORAGE_NOTES_PREFIX = 'wizwealth90.notes.';
    const STORAGE_THEME = 'wizwealth90.theme';
    const STORAGE_GOALS_PREFIX = 'wizwealth90.goals.';
    
    // ---- Profile Management ----
    function getAllProfiles(){
      const stored = localStorage.getItem(STORAGE_PROFILES);
      return stored ? JSON.parse(stored) : [];
    }
    
    function saveAllProfiles(profiles){
      localStorage.setItem(STORAGE_PROFILES, JSON.stringify(profiles));
    }
    
    function getCurrentProfile(){
      const id = localStorage.getItem(STORAGE_CURRENT_PROFILE);
      if (!id) return null;
      const profiles = getAllProfiles();
      return profiles.find(p => p.id === id) || null;
    }
    
    function setCurrentProfile(profileId){
      localStorage.setItem(STORAGE_CURRENT_PROFILE, profileId);
      updateProfileDisplay();
    }
    
    function createProfile(name){
      const profiles = getAllProfiles();
      const id = 'profile_' + Date.now();
      const newProfile = {
        id: id,
        name: name.trim(),
        createdAt: new Date().toISOString()
      };
      profiles.push(newProfile);
      saveAllProfiles(profiles);
      setCurrentProfile(id);
      return newProfile;
    }
    
    function deleteProfile(profileId){
      const profiles = getAllProfiles();
      const filtered = profiles.filter(p => p.id !== profileId);
      saveAllProfiles(filtered);
      
      // Clean up profile data
      for(let i=1; i<=90; i++){
        localStorage.removeItem(profileKey(profileId, STORAGE_NOTES_PREFIX + i));
      }
      for(let w=1; w<=13; w++){
        localStorage.removeItem(profileKey(profileId, STORAGE_GOALS_PREFIX + w));
      }
      localStorage.removeItem(profileKey(profileId, STORAGE_KEY_DAY));
      localStorage.removeItem(profileKey(profileId, STORAGE_THEME));
      
      // Switch to another profile or show modal
      if (filtered.length > 0){
        setCurrentProfile(filtered[0].id);
        renderDay(getCurrentDay());
      } else {
        localStorage.removeItem(STORAGE_CURRENT_PROFILE);
        showProfileModal(true);
      }
    }
    
    function profileKey(profileId, key){
      return `${profileId}.${key}`;
    }
    
    function updateProfileDisplay(){
      const profile = getCurrentProfile();
      if (profile){
        document.getElementById('currentProfile').textContent = profile.name;
      }
      renderProfileList();
    }
    
    function renderProfileList(){
      const profiles = getAllProfiles();
      const current = getCurrentProfile();
      const list = document.getElementById('profileList');
      list.innerHTML = '';
      
      // Add profile items
      profiles.forEach(profile => {
        const div = document.createElement('div');
        div.className = 'profile-item' + (profile.id === current?.id ? ' active' : '');
        div.textContent = profile.name;
        div.addEventListener('click', async () => {
          setCurrentProfile(profile.id);
          await renderDay(getCurrentDay());
          toggleProfileDropdown();
        });
        list.appendChild(div);
      });
      
      // Add delete options (if more than 1 profile)
      if (profiles.length > 1){
        profiles.forEach(profile => {
          const delDiv = document.createElement('div');
          delDiv.className = 'profile-item delete';
          delDiv.textContent = '🗑️ Remove ' + profile.name;
          delDiv.style.fontSize = '11px';
          delDiv.style.paddingLeft = '24px';
          delDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`Delete profile "${profile.name}"? All data for this profile will be removed.`)){
              deleteProfile(profile.id);
            }
          });
          list.appendChild(delDiv);
        });
      }
    }
    
    function toggleProfileDropdown(){
      document.getElementById('profileDropdown').classList.toggle('show');
    }
    
    function showProfileModal(isFirst = false){
      document.getElementById('profileModal').classList.remove('hidden');
      document.getElementById('profileNameInput').value = '';
      document.getElementById('profileNameInput').focus();
      
      if (isFirst){
        document.getElementById('modalTitle').textContent = 'Welcome! 👋';
        document.getElementById('modalDesc').textContent = 'Create your profile to start the program. Multiple people can use the same device.';
        document.getElementById('modalCancel').classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = 'Create new profile';
        document.getElementById('modalDesc').textContent = 'Each profile has its own progress and notes.';
        document.getElementById('modalCancel').classList.remove('hidden');
      }
    }
    
    function hideProfileModal(){
      document.getElementById('profileModal').classList.add('hidden');
    }
    
    async function handleProfileCreate(){
      const name = document.getElementById('profileNameInput').value.trim();
      if (!name){
        alert('Enter a name for the profile.');
        return;
      }
      
      createProfile(name);
      hideProfileModal();
      
      // Verify profile was created
      if (!getCurrentProfile()) {
        alert('An error occurred while creating the profile. Try again.');
        return;
      }
      
      // Initialize app after profile creation
      updateProfileDisplay();
      initTheme();
      
      const key = dayKey();
      if (key && !localStorage.getItem(key)) {
        localStorage.setItem(key, '1');
      }
      
      await renderDay(getCurrentDay());
    }

    function generateProgram(){
      const weeks = [
        {phase:'Self-Perception Reset', theme:'I am the source — not the numbers'},
        {phase:'Self-Perception Reset', theme:'From worry → presence'},
        {phase:'Belief Encoding', theme:'I am wealth'},
        {phase:'Belief Encoding', theme:'Feeling before evidence'},
        {phase:'Belief Encoding', theme:'V2 score & anchors'},
        {phase:'Belief Encoding', theme:'Synchronicity & trust'},
        {phase:'Frequency Embodiment', theme:'Move like the wealthy'},
        {phase:'Frequency Embodiment', theme:'Wiz-30 = autopilot'},
        {phase:'Frequency Embodiment', theme:'Environment design for money'},
        {phase:'Frequency Embodiment', theme:'Ease scales revenue'},
        {phase:'Integration', theme:'New baseline established'},
        {phase:'Integration', theme:'Celebrate, anchor, refine'},
        {phase:'Integration', theme:'Live the new standard'}  // Week 13 (days 85–90)
      ];

      const mantras = {
        reset:[
          'I am the awareness behind it all.',
          'Worry is just an old loop. I choose abundance.',
          'I am safe in the now; money moves to me.',
          'I observe — I am not my thoughts.'
        ],
        encode:[
          'I am a person money is drawn to.',
          'Feeling is the receipt.',
          'I am wealth in motion.',
          'My presence creates value now.'
        ],
        embody:[
          'I move like wealth.',
          'Ease serves me financially.',
          'Every action carries my new identity.',
          'I am the standard; money matches me.'
        ],
        integrate:[
          'This is my new baseline.',
          'I deserve and I receive.',
          'I choose peace; I choose wealth.',
          'Gratitude multiplies my flow.'
        ]
      };

      const dominoPools = {
        reset:[
          'Map 3 money-worry triggers & rewrite them.',
          'Cancel/unsubscribe from 1 negative input.',
          'Write a "thank you, past me" letter (5 min).',
          'Remove one small financial friction (e.g., an unused subscription).'
        ],
        encode:[
          'Write 5 "I am …" lines with feeling and record your voice (listen tonight).',
          'Create a V2 image and set it as phone background.',
          'Try micro‑manifestation: invite an unexpected compliment/opportunity.',
          'Write your 12‑month "wealth moment" in 3 sentences.'
        ],
        embody:[
          'Do 1 reach‑out (client, partner, friend).',
          'Publish 1 thing (post, pitch, DM).',
          'Sell something small today (pilot, advisory, package).',
          'Delegate/automate 1 energy‑draining task.'
        ],
        integrate:[
          'Write a list of new standards (minimum behaviors).',
          'Celebrate 3 wins — small or big.',
          'Plan 30–90 day "wealth ops" improvements.',
          'Book 1 rewarding experience to anchor the identity.'
        ]
      };

      const pep = {
        reset: [
          'Drink your coffee as if it were already true. You are bigger than the numbers.',
          'Worry is a body habit — not a forecast. Today you choose presence.',
          'You don\'t have to chase — you tune the signal. Let opportunities find you.',
          'Breathe 4‑2‑6 and feel the field go quiet. Direction is created here.'
        ],
        encode: [
          'Feeling before evidence: let the body feel "already owned."',
          'Affirmations work when they feel. Speak from a memory of a win.',
          'You are the person money looks for. Enter the room as such.',
          'Practice micro‑manifestation — let the world nod back.'
        ],
        embody: [
          'Move like wealth: simple, clear, generous with focus.',
          'Wiz‑30 is your autopilot — three small wins are enough.',
          'Environment before willpower: make right action easy.',
          'Ease scales revenue. Work smart, not heavy.'
        ],
        integrate: [
          'This is your new baseline. Let it show in small choices.',
          'Celebrate and anchor — what you celebrate, repeats.',
          'The last kilometer builds the habit. Keep the rhythm soft and steady.',
          'Gratitude multiplies. Say thank you out loud today.'
        ]
      };

      const routineByPhase = {
        reset: [
          '2 min still awareness: I observe; I am not my thoughts.',
          '3 min writing: What worries me? How does my wealthy self respond?',
          '5 min revision: play a new scene where you act as V2.'
        ],
        encode: [
          '3 min "I am …" with feeling (5–7 lines).',
          '4 min scene visualization: a concrete wealth moment.',
          '2 min physical anchor (hand on heart + slow breathing).'
        ],
        embody: [
          '1 min coffee anchor — "it\'s already mine."',
          '7 min First Domino (one small income‑moving action).',
          '2 min V2 score: 0–10 — what made the difference?'
        ],
        integrate: [
          '3 min gratitude for the evidence you see.',
          '5 min refine: what becomes my new minimum standard?',
          "2 min plan for tomorrow's First Domino."
        ]
      };

      const evening = [
        'V2 score (0–10) & micro‑win.',
        'What triggered worry? What do I choose next time?',
        'One proof that the flow worked for me today.',
        'One thing I simplify/eliminate tomorrow.'
      ];

      const days = [];
      for(let d=1; d<=90; d++){
        const weekIndex = Math.floor((d-1)/7);
        const wk = weeks[weekIndex];
        let phaseKey = 'reset';
        if (wk.phase.startsWith('Belief')) phaseKey = 'encode';
        else if (wk.phase.startsWith('Frequency')) phaseKey = 'embody';
        else if (wk.phase.startsWith('Integration')) phaseKey = 'integrate';

        const titles = {
          reset: ['Reset the loop','Presence leads','You are the source','Breathe, choose, create'],
          encode: ['I am wealth','Feeling first','V2 body leads','Practice proof'],
          embody: ['Move like wealth','Wiz‑30 = autopilot','Ease over force','Show the standard'],
          integrate: ['Baseline','Celebrate & anchor','Refine the standard','The new you stays']
        };
        const title = titles[phaseKey][d % 4];
        const pepMsg = pep[phaseKey][d % pep[phaseKey].length];
        const mantra = ({
          reset: mantras.reset,
          encode: mantras.encode,
          embody: mantras.embody,
          integrate: mantras.integrate
        })[phaseKey][d % 4];

        const dom = ({
          reset: dominoPools.reset,
          encode: dominoPools.encode,
          embody: dominoPools.embody,
          integrate: dominoPools.integrate
        })[phaseKey];

        days.push({
          day: d,
          phase: wk.phase,
          weekTheme: wk.theme,
          title,
          pep: pepMsg,
          routine: routineByPhase[phaseKey],
          domino: [dom[d % dom.length], dom[(d+1) % dom.length], dom[(d+2) % dom.length]],
          evening,
          mantra
        });
      }
      return days;
    }

    const PROGRAM = generateProgram();
    
    // ---- Wisdom Quotes ----
    const WISDOM_QUOTES = [
      "You are not here to fix yourself. You are here to remember.",
      "Wealth is a frequency before it's a number.",
      "Your past doesn't equal your future unless you let it.",
      "The Universe doesn't respond to need. It responds to signal.",
      "You don't attract what you want. You attract who you are.",
      "Comfort is expensive. Clarity is free.",
      "Your nervous system is your wealth ceiling.",
      "You become the 5 identities you spend the most time in.",
      "Manifestation without embodiment is fantasy.",
      "Money loves speed and clarity.",
      "Your current results are yesterday's thoughts becoming today's reality.",
      "The gap between where you are and where you want to be is called 'practice'.",
      "You don't need more strategy. You need more sovereignty.",
      "Wealth is an inside job that shows up outside.",
      "Your breakthrough is on the other side of your pattern.",
      "Energy is currency. Spend it wisely.",
      "What you tolerate, you teach the Universe to send you more of.",
      "Your vibe is your tribe. Your frequency is your fortune.",
      "The fastest way to wealth is to become the person who already has it.",
      "You can't hustle your way into alignment.",
      "Trust the timing. Question the fear.",
      "Your next level requires a new level of you.",
      "Scarcity is learned. Abundance is your natural state.",
      "The Universe doesn't work for you. It works through you."
    ];
    
    // ---- Energy Symbols ----
    const ENERGY_SYMBOLS = [
      {symbol: '⚡', text: 'Flow', color: 'var(--acc)'},
      {symbol: '✨', text: 'Clarity', color: 'var(--acc2)'},
      {symbol: '🌊', text: 'Ease', color: 'var(--acc)'},
      {symbol: '🔥', text: 'Power', color: '#ff8a8a'},
      {symbol: '🌙', text: 'Trust', color: 'var(--acc2)'},
      {symbol: '💎', text: 'Value', color: 'var(--acc)'},
      {symbol: '🎯', text: 'Focus', color: 'var(--acc2)'},
      {symbol: '🌟', text: 'Shine', color: 'var(--acc)'}
    ];

    // ---- Theme ----
    function getWeekNumber(day){ return Math.floor((day-1)/7)+1; }
    function goalsKey(week){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_GOALS_PREFIX + week); 
    }
    function notesKey(day){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_NOTES_PREFIX + day); 
    }
    function dayKey(){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_KEY_DAY); 
    }
    function themeKey(){ 
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, STORAGE_THEME); 
    }

    function initTheme(){
      const key = themeKey();
      const saved = key ? localStorage.getItem(key) || 'dark' : 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    function toggleTheme(){
      const key = themeKey();
      if (!key) return;
      
      // Add rotation animation
      const toggle = document.getElementById('themeToggle');
      toggle.classList.add('rotating');
      setTimeout(() => toggle.classList.remove('rotating'), 500);
      
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(key, next);
      updateThemeIcon(next);
    }

    function updateThemeIcon(theme){
      document.getElementById('themeToggle').textContent = theme === 'dark' ? '☀️' : '🌙';
    }

    // ---- Goals ----
    async function loadGoals(week){
      // Try Supabase first
      const supabGoals = await loadGoalsFromSupabase(week);
      if (supabGoals && supabGoals.length > 0) {
        return supabGoals;
      }
      
      // Fallback to localStorage
      const stored = localStorage.getItem(goalsKey(week));
      return stored ? JSON.parse(stored) : [];
    }

    async function saveGoals(week, goals){
      // Save to both Supabase and localStorage
      await saveGoalsToSupabase(week, goals);
      localStorage.setItem(goalsKey(week), JSON.stringify(goals));
    }

    async function renderGoals(week){
      const goals = await loadGoals(week);
      const list = document.getElementById('goalList');
      list.innerHTML = '';
      
      goals.forEach((goal, idx) => {
        const li = document.createElement('li');
        li.className = 'goal-item';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'goal-checkbox';
        cb.checked = goal.completed;
        cb.addEventListener('change', async ()=>{
          goals[idx].completed = cb.checked;
          await saveGoals(week, goals);
          await renderGoals(week);
        });
        
        const span = document.createElement('span');
        span.contentEditable = true;
        span.textContent = goal.text;
        span.className = 'goal-text ' + (goal.completed ? 'goal-completed' : '');
        span.setAttribute('data-original', goal.text);
        
        // Edit on blur (when user clicks away)
        span.addEventListener('blur', async ()=>{
          const newText = span.textContent.trim();
          if (newText && newText !== goal.text) {
            goals[idx].text = newText;
            await saveGoals(week, goals);
            span.setAttribute('data-original', newText);
          } else if (!newText) {
            // Restore if empty
            span.textContent = span.getAttribute('data-original');
          }
        });
        
        // Save on Enter, cancel on Escape
        span.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') {
            e.preventDefault();
            span.blur();
          } else if (e.key === 'Escape') {
            span.textContent = span.getAttribute('data-original');
            span.blur();
          }
        });
        
        // Delete button
        const delBtn = document.createElement('button');
        delBtn.className = 'goal-delete';
        delBtn.innerHTML = '🗑️';
        delBtn.title = 'Ta bort mål';
        delBtn.addEventListener('click', async ()=>{
          if (confirm('Ta bort detta mål?')) {
            goals.splice(idx, 1);
            await saveGoals(week, goals);
            await renderGoals(week);
          }
        });
        
        li.appendChild(cb);
        li.appendChild(span);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    async function addGoal(week, text){
      if (!text.trim()) return;
      const goals = await loadGoals(week);
      goals.push({text: text.trim(), completed: false});
      await saveGoals(week, goals);
      await renderGoals(week);
      document.getElementById('newGoal').value = '';
    }

    // ---- Toast Notifications ----
    function toast(msg){ 
      let t = document.querySelector('.toast'); 
      if(!t){ 
        t = document.createElement('div'); 
        t.className = 'toast'; 
        document.body.appendChild(t); 
      }
      t.textContent = msg; 
      t.classList.add('show'); 
      setTimeout(() => t.classList.remove('show'), 1500);
    }

    // ---- Done State ----
    function getDoneKey(day){
      const profile = getCurrentProfile();
      if (!profile) return null;
      return profileKey(profile.id, 'wizwealth90.done.' + day);
    }

    function isDayDone(day){
      const key = getDoneKey(day);
      if (!key) return false;
      return localStorage.getItem(key) === '1';
    }

    function markDayDone(day){
      const key = getDoneKey(day);
      if (!key) return;
      localStorage.setItem(key, '1');
    }

    function updateDoneButton(day){
      const btn = document.getElementById('btnDone');
      if (!btn) return;
      
      if (isDayDone(day)){
        btn.textContent = '✓ Day completed';
        btn.classList.add('completed');
        btn.disabled = true;
      } else {
        btn.textContent = '✨ Mark day as done';
        btn.classList.remove('completed');
        btn.disabled = false;
      }
    }

    // ---- UI helpers ----
    const el = (id)=>document.getElementById(id);
    
    function getCurrentDay(){
      const key = dayKey();
      const v = parseInt(key ? localStorage.getItem(key) || '1' : '1', 10);
      return isNaN(v)?1:Math.max(1, Math.min(90, v));
    }

    async function renderDay(n){
      if (!getCurrentProfile()) return; // Guard: no profile
      
      n = Math.max(1, Math.min(90, n));
      const key = dayKey();
      if (key) localStorage.setItem(key, String(n));
      
      const d = PROGRAM[n-1];
      const week = getWeekNumber(d.day);
      const kicker = `Day ${d.day} • Week ${week} • ${d.phase}`;
      
      // Progress bar
      const progress = Math.round((n / 90) * 100);
      el('progressText').textContent = `Day ${n} of 90 • Week ${week}`;
      el('progressPercent').textContent = `${progress}%`;
      const progressBar = el('progressFill');
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('role', 'progressbar');
      progressBar.setAttribute('aria-valuemin', '1');
      progressBar.setAttribute('aria-valuemax', '90');
      progressBar.setAttribute('aria-valuenow', String(n));
      
      // Energy symbol (rotate based on day)
      const energy = ENERGY_SYMBOLS[n % ENERGY_SYMBOLS.length];
      el('energySymbol').textContent = energy.symbol;
      el('energyText').textContent = energy.text;
      el('energyBadge').style.borderColor = energy.color;
      
      // Wisdom quote (rotate based on day)
      const wisdom = WISDOM_QUOTES[n % WISDOM_QUOTES.length];
      el('wisdomQuote').textContent = `"${wisdom}"`;

      el('kicker').textContent = kicker;
      el('title').textContent = d.title;
      el('theme').textContent = d.phase + ' • ' + d.weekTheme;
      el('weekTheme').textContent = d.weekTheme;
      el('pep').textContent = d.pep;

      const ulR = el('routine'); ulR.innerHTML='';
      d.routine.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulR.appendChild(li); });

      const ulD = el('domino'); ulD.innerHTML='';
      d.domino.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulD.appendChild(li); });

      const ulE = el('evening'); ulE.innerHTML='';
      d.evening.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ulE.appendChild(li); });

      el('mantra').textContent = d.mantra || '';
      
      // Trigger fade-in animation
      const card = el('dayCard');
      card.classList.remove('fade-in');
      void card.offsetWidth; // Force reflow
      card.classList.add('fade-in');
      
      await loadNotes(n);
      await renderGoals(week);
      updateDoneButton(n);
    }

    function nextDay(){ 
      if (!getCurrentProfile()) return;
      renderDay(getCurrentDay()+1); 
    }
    function prevDay(){ 
      if (!getCurrentProfile()) return;
      renderDay(getCurrentDay()-1); 
    }

    async function saveNotes(day){ 
      const content = el('notes').value;
      await saveNoteToSupabase(day, content);
      
      // Also save to localStorage as backup
      const key = notesKey(day);
      if (key) localStorage.setItem(key, content);
    }
    
    async function loadNotes(day){ 
      // Try Supabase first, fallback to localStorage
      const supabContent = await loadNoteFromSupabase(day);
      
      if (supabContent) {
        el('notes').value = supabContent;
      } else {
        // Fallback to localStorage
        const key = notesKey(day);
        el('notes').value = key ? localStorage.getItem(key) || '' : '';
      }
    }

    // Export/import state (day + notes + goals)
    function exportState(){
      const profile = getCurrentProfile();
      if (!profile) {
        alert('No profile selected. Create a profile first.');
        return;
      }
      
      const goalData = {};
      for(let w=1; w<=13; w++){
        const goals = loadGoals(w);
        if (goals.length > 0) goalData[w] = goals;
      }
      
      const themeK = themeKey();
      const data = {
        profileName: profile.name,
        day: getCurrentDay(),
        theme: themeK ? localStorage.getItem(themeK) || 'dark' : 'dark',
        notes: Object.fromEntries(
          Array.from({length:90}, (_,i)=>{
            const key = notesKey(i+1);
            return [String(i+1), key ? localStorage.getItem(key) || '' : ''];
          })
          .filter(([,v])=>v && v.trim()!=='')
        ),
        goals: goalData
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `wizwealth90_${profile.name}_${new Date().toISOString().split('T')[0]}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function importState(file){
      if (!getCurrentProfile()) {
        alert('No profile selected. Create a profile first.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          // Validate data
          if (typeof data !== 'object' || !data.day) {
            throw new Error('Invalid file format');
          }
          
          if (data.day < 1 || data.day > 90) {
            throw new Error('Invalid day number');
          }
          
          const dayK = dayKey();
          if (data.day && dayK) localStorage.setItem(dayK, String(data.day));
          
          const themeK = themeKey();
          if (data.theme && themeK) {
            localStorage.setItem(themeK, data.theme);
            document.documentElement.setAttribute('data-theme', data.theme);
            updateThemeIcon(data.theme);
          }
          
          if (data.notes) {
            Object.entries(data.notes).forEach(([k,v])=>{
              const d = parseInt(k,10);
              const noteK = notesKey(d);
              if (d>=1 && d<=90 && noteK) {
                localStorage.setItem(noteK, v);
              }
            });
          }
          
          if (data.goals) {
            Object.entries(data.goals).forEach(([w,goals])=>{
              const week = parseInt(w,10);
              if (week>=1 && week<=13) saveGoals(week, goals);
            });
          }
          
          renderDay(getCurrentDay());
          alert('✅ Imported!');
        } catch(e){ 
          alert('❌ Invalid file: ' + e.message); 
        }
      };
      reader.readAsText(file);
    }

    // Handlers
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('btnNext').addEventListener('click', nextDay);
    document.getElementById('btnPrev').addEventListener('click', prevDay);
    document.getElementById('btnToday').addEventListener('click', ()=>renderDay(getCurrentDay()));
    document.getElementById('btnGoto').addEventListener('click', ()=>{
      const n = parseInt(document.getElementById('gotoDay').value, 10);
      if (!isNaN(n)) renderDay(n);
    });
    document.getElementById('btnReset').addEventListener('click', ()=>{
      const profile = getCurrentProfile();
      if (!profile) {
        alert('No profile selected.');
        return;
      }
      
      if (confirm(`Reset day, theme, notes and goals for ${profile.name}?`)){
        for(let i=1;i<=90;i++) {
          const noteK = notesKey(i);
          if (noteK) localStorage.removeItem(noteK);
        }
        for(let w=1;w<=13;w++) {
          const goalK = goalsKey(w);
          if (goalK) localStorage.removeItem(goalK);
        }
        
        const dayK = dayKey();
        const themeK = themeKey();
        if (dayK) localStorage.setItem(dayK, '1');
        if (themeK) localStorage.setItem(themeK, 'dark');
        
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon('dark');
        renderDay(1);
      }
    });
    document.getElementById('btnExport').addEventListener('click', exportState);
    document.getElementById('btnImport').addEventListener('click', ()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if (file) importState(file);
      e.target.value = '';
    });
    document.getElementById('btnClearNotes').addEventListener('click', ()=>{
      if (confirm('Clear notes for this day?')){
        const d = getCurrentDay();
        localStorage.removeItem(notesKey(d));
        loadNotes(d);
      }
    });
    document.getElementById('notes').addEventListener('input', ()=>saveNotes(getCurrentDay()));
    document.getElementById('newGoal').addEventListener('keypress', async (e)=>{
      if (e.key === 'Enter'){
        const week = getWeekNumber(getCurrentDay());
        await addGoal(week, e.target.value);
      }
    });
    
    // Done button handler
    document.getElementById('btnDone').addEventListener('click', ()=>{
      if (!getCurrentProfile()) return;
      const day = getCurrentDay();
      if (isDayDone(day)) return;
      
      markDayDone(day);
      updateDoneButton(day);
      
      // Trigger animations
      const card = document.getElementById('dayCard');
      card.classList.add('donePulse');
      setTimeout(() => card.classList.remove('donePulse'), 600);
      
      toast('✨ Day integrated');
    });
    
    // Mantra copy-to-clipboard
    document.getElementById('mantra').addEventListener('click', async ()=>{
      const mantraText = document.getElementById('mantra').textContent;
      if (!mantraText) return;
      
      try {
        await navigator.clipboard.writeText(mantraText);
        toast('📋 Mantra copied');
      } catch (err) {
        console.error('Failed to copy:', err);
        toast('⚠️ Couldn't copy');
      }
    });
    
    // Profile handlers
    document.getElementById('profileBtn').addEventListener('click', toggleProfileDropdown);
    document.getElementById('btnNewProfile').addEventListener('click', ()=>{
      toggleProfileDropdown();
      showProfileModal(false);
    });
    document.getElementById('modalConfirm').addEventListener('click', handleProfileCreate);
    document.getElementById('modalCancel').addEventListener('click', hideProfileModal);
    document.getElementById('profileNameInput').addEventListener('keypress', (e)=>{
      if (e.key === 'Enter') handleProfileCreate();
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e)=>{
      const dropdown = document.getElementById('profileDropdown');
      const btn = document.getElementById('profileBtn');
      if (!dropdown.contains(e.target) && !btn.contains(e.target)){
        dropdown.classList.remove('show');
      }
    });

    // Boot
    (async function init(){
      const profile = getCurrentProfile();
      if (!profile){
        showProfileModal(true);
        return;
      }
      
      updateProfileDisplay();
      initTheme();
      if (!localStorage.getItem(dayKey())) localStorage.setItem(dayKey(), '1');
      await renderDay(getCurrentDay());
    })();
  </script>
</body>
</html>

